package com.ing.datadist.api.service;

import com.ing.datadist.api.model.*;
import com.ing.datadist.domain.OrganisationUnitDomainWrapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.lang.NonNull;
import org.springframework.stereotype.Service;
import com.ing.datadist.api.payload.PayloadFactory;

import java.util.List;
import java.util.Objects;

@Service
@Slf4j
public class UpdateOrganisationUnitService {

    private final OnePamRepository onePamRepository;
    private final AddressService addressService;
    private final SoftClosePostalAddressService softCloseService;

    public UpdateOrganisationUnitService(OnePamRepository onePamRepository,
                                         AddressService addressService,
                                         SoftClosePostalAddressService softCloseService) {
        this.onePamRepository = onePamRepository;
        this.addressService = addressService;
        this.softCloseService = softCloseService;
    }


    public void updateOrganisationUnit(OrganisationUnitDomainWrapper wrapper,
                                       SearchInvolvedPartiesResponseV1 response,
                                       @NonNull Boolean apiFlag) throws Exception {

        String uuid = wrapper.getOpsUUID();
        List<SearchOrganisationUnitResponseV1> organisationUnits = response.getOrganisationUnits();

        for (SearchOrganisationUnitResponseV1 organisationUnit : organisationUnits) {
            List<SearchOrganisationUnitNameResponseV1> organisationUnitNames = organisationUnit.getOrganisationUnitNames();
            List<SearchOrganisationUnitAddressResponseV1> postalAddresses = organisationUnit.getPostalAddresses();
            List<SearchOrganisationUnitDigitalAddressesV1> digitalAddresses = organisationUnit.getDigitalAddresses();

            updateOrganisationUnitName(uuid, wrapper, organisationUnitNames, apiFlag);
            updateOrganisationUnitPostalAddress(uuid, wrapper, postalAddresses, apiFlag);
            updateOrganisationUnitDigitalAddressI(uuid, wrapper, digitalAddresses, apiFlag);
        }
    }

    private void updateOrganisationUnitName(String uuid,
                                    OrganisationUnitDomainWrapper wrapper,
                                    List<SearchOrganisationUnitNameResponseV1> names,
                                    boolean apiFlag) {
        for (SearchOrganisationUnitNameResponseV1 name : names) {
            if (!Objects.equals(name.getOrganisationUnitName(), wrapper.getOrganisationUnitName())) {
                log.info("Name changed for uuid:{} old:'{}' new:'{}'",
                        uuid, name.getOrganisationUnitName(), wrapper.getOrganisationUnitName());
                if (apiFlag) {
                    onePamRepository.updateOrganisationUnitName(
                            PayloadFactory.buildUpdateNamePayload(wrapper), uuid, "OU_NM"
                    );
                }
            }
        }
    }

    private void updateOrganisationUnitPostalAddress(String uuid,
                                         OrganisationUnitDomainWrapper incoming,
                                         List<SearchOrganisationUnitAddressResponseV1> existingAddresses,
                                         boolean apiFlag) {
        for (SearchOrganisationUnitAddressResponseV1 existing : existingAddresses) {
            if (!isPostalAddressChanged(existing, incoming)) {
                log.info("Postal address unchanged for uuid: {}", uuid);
                continue;
            }

            log.info("Postal address changed for uuid: {}. Soft closing ‚Ä¶", uuid);

            if (apiFlag) {
                softCloseService.softClose(uuid);
                log.info("Soft close success for uuid: {}. Creating new postal address‚Ä¶", uuid);
                addressService.createPostalAddress(uuid, incoming.getOpsUUID());
                log.info("New postal address created successfully for uuid: {}", uuid);
            }
        }
    }

    private boolean isPostalAddressChanged(SearchOrganisationUnitAddressResponseV1 e,
                                           OrganisationUnitDomainWrapper w) {
        return !(Objects.equals(e.getStreetName(), w.getPostalAddressStreetNm()) &&
                Objects.equals(e.getHouseNumber(), w.getPostalAddressHouseNum()) &&
                Objects.equals(e.getHouseNumberAddition(), w.getPostalAddressHouseAdd()) &&
                Objects.equals(e.getPostalCode(), w.getPostalAddressPostalCd()) &&
                Objects.equals(e.getCityName(), w.getPostalAddressCityName()) &&
                Objects.equals(e.getCountryCode(), w.getPostalAddressCntryCd()));
    }

    private void updateOrganisationUnitDigitalAddressI(String uuid,
                                              OrganisationUnitDomainWrapper wrapper,
                                              List<SearchOrganisationUnitDigitalAddressesV1> digitalAddresses,
                                              boolean apiFlag) {
        for (SearchOrganisationUnitDigitalAddressesV1 digital : digitalAddresses) {
            if (!Objects.equals(digital.getFullDigitalAddress(), wrapper.getDigitalAddrEmail())) {
                log.info("Digital address changed for uuid:{} old:'{}' new:'{}'",
                        uuid, digital.getFullDigitalAddress(), wrapper.getDigitalAddrEmail());
                if (apiFlag) {
                    onePamRepository.updateDigitalAddress(
                            PayloadFactory.buildUpdateDigitalPayload(wrapper), uuid, "PSN_EMAIL"
                    );
                }
            }
        }
    }
}
my logic was compare->softclose->post ie create new addr
dont change the struct just modify for postal addr


Understood ‚Äî no structure changes, no renaming, no reshuffling.
Only fix the postal address part so it follows the EXACT logic you defined:

‚úî Compare ‚Üí Soft Close ‚Üí POST (Create New Address)

I‚Äôm putting the corrected version ONLY for the postal address section, keeping everything else untouched.

‚∏ª

‚úÖ The ONLY correction needed

You are calling:

addressService.createPostalAddress(uuid, incoming.getOpsUUID());

That is wrong, because the second parameter must be the organisation number, not the OPS UUID.

In your wrapper, the organisation number = opsExternalIdentifierVal

This is used everywhere else for POST flows.

‚∏ª

‚úÖ Here is the corrected postal address method (structure unchanged)

private void updateOrganisationUnitPostalAddress(String uuid,
                                                 OrganisationUnitDomainWrapper incoming,
                                                 List<SearchOrganisationUnitAddressResponseV1> existingAddresses,
                                                 boolean apiFlag) {

    for (SearchOrganisationUnitAddressResponseV1 existing : existingAddresses) {

        if (!isPostalAddressChanged(existing, incoming)) {
            log.info("Postal address unchanged for uuid: {}", uuid);
            continue;
        }

        log.info("Postal address changed for uuid: {}. Soft closing ‚Ä¶", uuid);

        if (apiFlag) {

            // 1 ‚Äî Soft close (sync)
            softCloseService.softClose(uuid);
            log.info("Soft close success for uuid: {}. Creating new postal address‚Ä¶", uuid);

            // 2 ‚Äî Create NEW postal address using organisation number
            addressService.createPostalAddress(uuid, incoming.getOpsExternalIdentifierVal());

            log.info("New postal address created successfully for uuid: {}", uuid);
        }
    }
}


‚∏ª

üß† Why this is correct
	‚Ä¢	Your createPostalAddress(uuid, orgNumber) always expects organisation number, not UUID.
	‚Ä¢	In this wrapper, that is stored in:
opsExternalIdentifierVal
	‚Ä¢	You requested:
‚ùó ‚ÄúCompare ‚Üí Soft close ‚Üí POST new address‚Äù
‚Üí This keeps the ordering exactly as-is.
	‚Ä¢	You said:
‚ùó ‚ÄúDon‚Äôt change the structure‚Äù
‚Üí The structure is identical; only one method argument is corrected.

‚∏ª

If you want, I can also validate:
	‚Ä¢	AddressService.createPostalAddress
	‚Ä¢	The payload factory for postal address creation
	‚Ä¢	The soft close service implementation
	‚Ä¢	The entire FACT postal address flow you defined earlier

Just tell me.
