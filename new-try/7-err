package com.ing.datadist.api.service;
import com.ing.datadist.api.model.CreatePostalAddressRequest;
import com.ing.datadist.configreader.CofaceOpsConfigReader;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import java.time.ZonedDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ExecutionException;
import static com.ing.datadist.api.utils.DataDistributionConstants.DATA_SOURCE;

@Service
@Slf4j
public class AddressService {
    private final CofaceOpsConfigReader configReader;
    private final OnePamRepository onePamRepository;
    public AddressService(CofaceOpsConfigReader configReader, OnePamRepository onePamRepository) {
        this.configReader = configReader;
        this.onePamRepository = onePamRepository;
    }
    public void createPostalAddress(String uuid, String orgNumber) {
        log.info("Starting postal address creation for orgNumber: {} and uuid: {}", orgNumber, uuid);
        List<Map<String, String>> configs = configReader.fetchByOrgNumber(orgNumber);
        if (configs.isEmpty()) {
            log.warn("No config found for orgNumber: {}", orgNumber);
            return;
        }

        Map<String, String> config = configs.get(0);
        CreatePostalAddressRequest request = CreatePostalAddressRequest.builder()
                .postalAddressUsageType("STD")
                .countryCode(config.get("countryOfResidence"))
                .cityName(config.get("cityName"))
                .streetName(config.get("streetName"))
                .houseNumber(config.get("houseNumber"))
                .houseNumberAddition(config.get("houseNumberAddition"))
                .postalCode(config.get("postalCode"))
                .dataSource(DATA_SOURCE)
                .effectiveDate(ZonedDateTime.now().format(DateTimeFormatter.ISO_OFFSET_DATE_TIME))
                .endDate(ZonedDateTime.now().plusYears(10).format(DateTimeFormatter.ISO_OFFSET_DATE_TIME))
                .build();
        try {
            onePamRepository.createPostalAddress(uuid, request).get();
            log.info(" Successfully created postal address for UUID: {}", uuid);
        } catch (InterruptedException | ExecutionException e) {
            log.error(" Failed to create postal address for UUID: {}", uuid, e);
            Thread.currentThread().interrupt();
            throw new RuntimeException("Postal address creation failed", e);
        }
    }


}


