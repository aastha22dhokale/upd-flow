package com.ing.datadist.api.service;

import com.ing.datadist.api.model.SearchInvolvedPartiesResponseV1;
import com.ing.datadist.api.model.SearchOrganisationUnitAddressResponseV1;
import com.ing.datadist.api.model.SearchOrganisationUnitNameResponseV1;
import com.ing.datadist.api.model.SearchOrganisationUnitResponseV1;
import com.ing.datadist.api.model.SearchOrganisationUnitDigitalAddressesV1;
import com.ing.datadist.domain.OrganisationUnitDomainWrapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.lang.NonNull;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Objects;

@Service
@Slf4j
public class UpdateOrganisationUnitService {

    private final OnePamRepository onePamRepository;
    private final AddressService addressService;

    public UpdateOrganisationUnitService(OnePamRepository onePamRepository,
                                         AddressService addressService) {
        this.onePamRepository = onePamRepository;
        this.addressService = addressService;
    }

    /**
     * MAIN ENTRY POINT
     */
    public void updateOrganisationUnit(OrganisationUnitDomainWrapper wrapper,
                                       SearchInvolvedPartiesResponseV1 response,
                                       @NonNull Boolean apiFlag) throws Exception {

        String uuid = wrapper.getOpsUUID();
        List<SearchOrganisationUnitResponseV1> organisationUnits = response.getOrganisationUnits();

        for (SearchOrganisationUnitResponseV1 ou : organisationUnits) {

            // =====================
            // 1 — Update Name
            // =====================
            updateNameIfNeeded(uuid, wrapper, ou.getOrganisationUnitNames(), apiFlag);

            // =====================
            // 2 — Update Postal Address (Compare → Soft Close → Create New)
            // =====================
            updatePostalAddressFlow(uuid, wrapper, ou.getPostalAddresses(), apiFlag);

            // =====================
            // 3 — Update Digital Address
            // =====================
            updateDigitalAddressIfNeeded(uuid, wrapper, ou.getDigitalAddresses(), apiFlag);
        }
    }


    // ============================================================
    // NAME UPDATE
    // ============================================================
    private void updateNameIfNeeded(
            String uuid,
            OrganisationUnitDomainWrapper wrapper,
            List<SearchOrganisationUnitNameResponseV1> names,
            boolean apiFlag) {

        for (SearchOrganisationUnitNameResponseV1 name : names) {

            if (!Objects.equals(wrapper.getOrganisationUnitName(), name.getOrganisationUnitName())) {
                log.info("Name changed for uuid:{} old:{} new:{}",
                        uuid, name.getOrganisationUnitName(), wrapper.getOrganisationUnitName());

                if (apiFlag) {
                    onePamRepository.updateOrganisationUnitName(
                            PayloadFactory.buildUpdateNamePayload(wrapper, wrapper.getOrganisationUnitName()),
                            uuid,
                            "DD"
                    );
                }
            }
        }
    }


    // ============================================================
    // POSTAL ADDRESS FLOW (Compare → Soft Close → Create)
    // ============================================================
    private void updatePostalAddressFlow(
            String uuid,
            OrganisationUnitDomainWrapper incoming,
            List<SearchOrganisationUnitAddressResponseV1> existingAddresses,
            boolean apiFlag) {

        for (SearchOrganisationUnitAddressResponseV1 existing : existingAddresses) {

            if (!isPostalAddressChanged(existing, incoming)) {
                log.info("Postal address unchanged for uuid: {}", uuid);
                continue;
            }

            log.info("Postal address changed for uuid: {}. Soft closing …", uuid);

            if (apiFlag) {
                // 1) SOFT CLOSE
                addressService.softClosePostalAddress(uuid);

                log.info("Soft close success for uuid: {}. Creating new postal address…", uuid);

                // 2) CREATE NEW POSTAL ADDRESS
                addressService.createPostalAddress(uuid, incoming);

                log.info("New postal address created successfully for uuid: {}", uuid);
            }
        }
    }


    // Compare ALL fields in ONE method (as you wanted)
    private boolean isPostalAddressChanged(
            SearchOrganisationUnitAddressResponseV1 existing,
            OrganisationUnitDomainWrapper incoming) {

        if (!Objects.equals(existing.getStreetName(), incoming.getPostalAddressStreetNm())) return true;
        if (!Objects.equals(existing.getHouseNumber(), incoming.getPostalAddressHouseNum())) return true;
        if (!Objects.equals(existing.getHouseNumberAddition(), incoming.getPostalAddressHouseAdd())) return true;
        if (!Objects.equals(existing.getPostalCode(), incoming.getPostalAddressPostalCd())) return true;
        if (!Objects.equals(existing.getCityName(), incoming.getPostalAddressCityName())) return true;
        if (!Objects.equals(existing.getCountryCode(), incoming.getPostalAddressCntryCd())) return true;

        return false;
    }


    // ============================================================
    // DIGITAL ADDRESS UPDATE
    // ============================================================
    private void updateDigitalAddressIfNeeded(
            String uuid,
            OrganisationUnitDomainWrapper wrapper,
            List<SearchOrganisationUnitDigitalAddressesV1> digitalAddresses,
            boolean apiFlag) {

        for (SearchOrganisationUnitDigitalAddressesV1 digital : digitalAddresses) {

            if (!Objects.equals(wrapper.getDigitalAddrEmail(), digital.getFullDigitalAddress())) {
                log.info("Digital address changed for uuid:{} old:{} new:{}",
                        uuid, digital.getFullDigitalAddress(), wrapper.getDigitalAddrEmail());

                if (apiFlag) {
                    onePamRepository.updateDigitalAddress(
                            PayloadFactory.buildUpdateDigitalPayload(wrapper),
                            uuid,
                            "DD"
                    );
                }
            }
        }
    }

}
