upd org unit service just got updated package com.ing.datadist.api.service; import com.ing.datadist.api.model.*; import com.ing.datadist.domain.OrganisationUnitDomainWrapper; import lombok.extern.slf4j.Slf4j; import org.springframework.stereotype.Service; import java.time.LocalDate; import java.time.format.DateTimeFormatter; import java.util.List; import java.util.Objects; @Service @Slf4j public class UpdateOrganisationUnitService { public static final DateTimeFormatter formatter = DateTimeFormatter.ofPattern("dd-MM-yyyy"); public void updateOrganisationUnit(OrganisationUnitDomainWrapper wrapper, SearchInvolvedPartiesResponseV1 response) throws Exception { String uuid = wrapper.getOpsUUID(); List<SearchOrganisationUnitResponseV1> organisationUnits = response.getOrganisationUnits(); for (SearchOrganisationUnitResponseV1 organisationUnit : organisationUnits) { List<SearchOrganisationUnitNameResponseV1> organisationUnitNames = organisationUnit.getOrganisationUnitNames(); List<SearchOrganisationUnitAddressResponseV1> postalAddresses = organisationUnit.getPostalAddresses(); List<SearchOrganisationUnitDigitalAddressesV1> digitalAddresses = organisationUnit.getDigitalAddresses(); for (SearchOrganisationUnitNameResponseV1 name : organisationUnitNames) { if ((wrapper.getOrganisationUnitName() != null && !wrapper.getOrganisationUnitName().isEmpty() && name.getOrganisationUnitName() != null) && !Objects.equals(wrapper.getOrganisationUnitName(), name.getOrganisationUnitName())) { log.info("Update organisationUnit name changed for uuid:{} new:{} old:{} ", uuid, wrapper.getOrganisationUnitName(), name.getOrganisationUnitName()); //Call update name API } } for (SearchOrganisationUnitAddressResponseV1 address : postalAddresses) { if ((wrapper.getPostalAddressStreetNm() != null && !wrapper.getPostalAddressStreetNm().isEmpty() && address.getStreetName() != null) && !Objects.equals(wrapper.getPostalAddressStreetNm(), address.getStreetName())) { log.info("Update organisationUnit StreetName changed for uuid:{} new:{} old:{} ", uuid, wrapper.getPostalAddressStreetNm(), address.getStreetName()); //Call update postal addr API } if ((wrapper.getPostalAddressHouseNum() != null && !wrapper.getPostalAddressHouseNum().isEmpty() && address.getHouseNumber() != null) && !Objects.equals(wrapper.getPostalAddressHouseNum(), address.getHouseNumber())) { log.info("Update organisationUnit HouseNum changed for uuid:{} new:{} old:{} ", uuid, wrapper.getPostalAddressHouseNum(), address.getHouseNumber()); //Call update postal addr API } if ((wrapper.getPostalAddressHouseAdd() != null && !wrapper.getPostalAddressHouseAdd().isEmpty() && address.getHouseNumberAddition() != null) && !Objects.equals(wrapper.getPostalAddressHouseAdd(), address.getHouseNumberAddition())) { log.info("Update organisationUnit HouseAdd changed for uuid:{} new:{} old:{} ", uuid, wrapper.getPostalAddressHouseAdd(), address.getHouseNumberAddition()); //Call update postal addr API } if ((wrapper.getPostalAddressPostalCd() != null && !wrapper.getPostalAddressPostalCd().isEmpty() && address.getPostalCode() != null) && !Objects.equals(wrapper.getPostalAddressPostalCd(), address.getPostalCode())) { log.info("Update organisationUnit PostalCode changed for uuid:{} new:{} old:{} ", uuid, wrapper.getPostalAddressPostalCd(), address.getPostalCode()); //Call update postal addr API } if ((wrapper.getPostalAddressCityName() != null && !wrapper.getPostalAddressCityName().isEmpty() && address.getCityName() != null) && !Objects.equals(wrapper.getPostalAddressCityName(), address.getCityName())) { log.info("Update organisationUnit CityName changed for uuid:{} new:{} old:{} ", uuid, wrapper.getPostalAddressCityName(), address.getCityName()); //Call update postal addr API } if ((wrapper.getPostalAddressCntryCd() != null && !wrapper.getPostalAddressCntryCd().isEmpty() && address.getCountryCode() != null) && !Objects.equals(wrapper.getPostalAddressCntryCd(), address.getCountryCode())) { log.info("Update organisationUnit CountryCode changed for uuid:{} new:{} old:{} ", uuid, wrapper.getPostalAddressCntryCd(), address.getCountryCode()); //Call update postal addr API } } for (SearchOrganisationUnitDigitalAddressesV1 digitalAddress : digitalAddresses) { if ((wrapper.getDigitalAddrEmail() != null && !wrapper.getDigitalAddrEmail().isEmpty() && digitalAddress.getFullDigitalAddress() != null) && !Objects.equals(wrapper.getDigitalAddrEmail(), digitalAddress.getFullDigitalAddress())) { log.info("Update organisationUnit FullDigitalAddress changed for uuid:{} new:{} old:{} ", uuid, wrapper.getDigitalAddrEmail(), digitalAddress.getFullDigitalAddress()); //Call update digital addr API } } } if (compareExitDate(wrapper.getOpsExtIdExpiryDate())) { //call delete api flow } } private boolean compareExitDate(String exitDate) { try { log.info("compareExitDate date:{}", exitDate); if (exitDate == null || exitDate.isEmpty()) { return false; } else { LocalDate exit = LocalDate.parse(exitDate, formatter); LocalDate today = LocalDate.now(); return !exit.isAfter(today); } } catch (Exception e) { log.error("compareExitDate error", e); throw e; } } } this was mine put my class into new and give final version package com.ing.datadist.api.service; import com.ing.datadist.api.model.*; import com.ing.datadist.domain.OrganisationUnitDomainWrapper; import lombok.extern.slf4j.Slf4j; import org.springframework.lang.NonNull; import org.springframework.stereotype.Service; import com.ing.datadist.api.payload.PayloadFactory; import java.util.List; import java.util.Objects; @Service @Slf4j public class UpdateOrganisationUnitService { private final OnePamRepository onePamRepository; private final AddressService addressService; private final SoftClosePostalAddressService softCloseService; public UpdateOrganisationUnitService(OnePamRepository onePamRepository, AddressService addressService, SoftClosePostalAddressService softCloseService) { this.onePamRepository = onePamRepository; this.addressService = addressService; this.softCloseService = softCloseService; } /** * Main entry point: Compare existing vs incoming data and update if needed. */ public void updateOrganisationUnit(OrganisationUnitDomainWrapper wrapper, SearchInvolvedPartiesResponseV1 response, @NonNull Boolean apiFlag) throws Exception { String uuid = wrapper.getOpsUUID(); List<SearchOrganisationUnitResponseV1> organisationUnits = response.getOrganisationUnits(); for (SearchOrganisationUnitResponseV1 organisationUnit : organisationUnits) { updateOrganisationUnitName(uuid, wrapper, organisationUnit.getOrganisationUnitNames(), apiFlag); updateOrganisationUnitPostalAddress(uuid, wrapper, organisationUnit.getPostalAddresses(), apiFlag); updateOrganisationUnitDigitalAddress(uuid, wrapper, organisationUnit.getDigitalAddresses(), apiFlag); } } /** * Update Organisation Unit Name if changed. */ private void updateOrganisationUnitName(String uuid, OrganisationUnitDomainWrapper wrapper, List<SearchOrganisationUnitNameResponseV1> names, boolean apiFlag) { for (SearchOrganisationUnitNameResponseV1 name : names) { if (!Objects.equals(name.getOrganisationUnitName(), wrapper.getOrganisationUnitName())) { log.info("Name changed for uuid:{} old:'{}' new:'{}'", uuid, name.getOrganisationUnitName(), wrapper.getOrganisationUnitName()); if (apiFlag) { onePamRepository.updateOrganisationUnitName( PayloadFactory.buildUpdateNamePayload(wrapper), uuid, "OU_NM" ); } } } } /** * Compare → Soft Close → Create New Postal Address. */ private void updateOrganisationUnitPostalAddress(String uuid, OrganisationUnitDomainWrapper incoming, List<SearchOrganisationUnitAddressResponseV1> existingAddresses, boolean apiFlag) { for (SearchOrganisationUnitAddressResponseV1 existing : existingAddresses) { if (!isPostalAddressChanged(existing, incoming)) { log.info("Postal address unchanged for uuid: {}", uuid); continue; } log.info("Postal address changed for uuid: {}. Soft closing …", uuid); if (apiFlag) { // 1 — Soft close old address softCloseService.softClose(uuid); log.info("Soft close success for uuid: {}.", uuid); // 2 — Create new postal address using organisation number (NOT OPS UUID) addressService.createPostalAddress(uuid, incoming.getOpsExternalIdentifierVal()); log.info("New postal address created successfully for uuid: {}", uuid); } } } /** * Check if any postal address field differs. */ private boolean isPostalAddressChanged(SearchOrganisationUnitAddressResponseV1 e, OrganisationUnitDomainWrapper w) { return !(Objects.equals(e.getStreetName(), w.getPostalAddressStreetNm()) && Objects.equals(e.getHouseNumber(), w.getPostalAddressHouseNum()) && Objects.equals(e.getHouseNumberAddition(), w.getPostalAddressHouseAdd()) && Objects.equals(e.getPostalCode(), w.getPostalAddressPostalCd()) && Objects.equals(e.getCityName(), w.getPostalAddressCityName()) && Objects.equals(e.getCountryCode(), w.getPostalAddressCntryCd())); } /** * Update Digital Address if changed. */ private void updateOrganisationUnitDigitalAddress(String uuid, OrganisationUnitDomainWrapper wrapper, List<SearchOrganisationUnitDigitalAddressesV1> digitalAddresses, boolean apiFlag) { for (SearchOrganisationUnitDigitalAddressesV1 digital : digitalAddresses) { if (!Objects.equals(digital.getFullDigitalAddress(), wrapper.getDigitalAddrEmail())) { log.info("Digital address changed for uuid:{} old:'{}' new:'{}'", uuid, digital.getFullDigitalAddress(), wrapper.getDigitalAddrEmail()); if (apiFlag) { onePamRepository.updateDigitalAddress( PayloadFactory.buildUpdateDigitalPayload(wrapper), uuid, "PSN_EMAIL" ); } } } }
if u hv doubts ask
