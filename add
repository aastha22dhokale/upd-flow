package com.ing.datadist.api.service;
import com.ing.datadist.api.model.CreatePostalAddressRequest;
import com.ing.datadist.configreader.CofaceOpsConfigReader;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import java.time.ZonedDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ExecutionException;
import static com.ing.datadist.api.utils.DataDistributionConstants.DATA_SOURCE;

@Service
@Slf4j
public class AddressService {
    private final CofaceOpsConfigReader configReader;
    private final OnePamRepository onePamRepository;
    public AddressService(CofaceOpsConfigReader configReader, OnePamRepository onePamRepository) {
        this.configReader = configReader;
        this.onePamRepository = onePamRepository;
    }
    public void createPostalAddress(String uuid, String orgNumber) {
        log.info("Starting postal address creation for orgNumber: {} and uuid: {}", orgNumber, uuid);
        List<Map<String, String>> configs = configReader.fetchByOrgNumber(orgNumber);
        if (configs.isEmpty()) {
            log.warn("No config found for orgNumber: {}", orgNumber);
            return;
        }

        Map<String, String> config = configs.get(0);
        CreatePostalAddressRequest request = CreatePostalAddressRequest.builder()
                .postalAddressUsageType("STD")
                .countryCode(config.get("countryOfResidence"))
                .cityName(config.get("cityName"))
                .streetName(config.get("streetName"))
                .houseNumber(config.get("houseNumber"))
                .houseNumberAddition(config.get("houseNumberAddition"))
                .postalCode(config.get("postalCode"))
                .dataSource(DATA_SOURCE)
                .effectiveDate(ZonedDateTime.now().format(DateTimeFormatter.ISO_OFFSET_DATE_TIME))
                .endDate(ZonedDateTime.now().plusYears(10).format(DateTimeFormatter.ISO_OFFSET_DATE_TIME))
                .build();
        try {
            onePamRepository.createPostalAddress(uuid, request).get();
            log.info(" Successfully created postal address for UUID: {}", uuid);
        } catch (InterruptedException | ExecutionException e) {
            log.error(" Failed to create postal address for UUID: {}", uuid, e);
            Thread.currentThread().interrupt();
            throw new RuntimeException("Postal address creation failed", e);
        }
    }
}

API & Stream Marketplace
Home
APIs
Topics
Useful links
Subscribe
OpenApiDocument
P00007
OAS 3
Involved Party API

Share
View in Console
Back to API details
Create a postal address for the party identified by the uuid.
post
/v5/involved-parties/{uuid}/postal-addresses

üè∑Ô∏è PostalAddresses

Creates a current postal address for the party identified by the uuid. Only one current Postal Address per postalAddressUsageType maybe created.

Creates a future postal address for the party identified by the uuid, when the party already has a current postal address with the same postalAddressUsageType. Only one future Postal Address per postalAddressUsageType maybe created. The endDate of a future postal address must be empty, and the effectiveDate must be greater than the endDate of the current postal address with the same usage type. The current postal address must have an endDate set in order to be able to create the future postal address.

header params
X-ING-LastUpdateUser string required
The LastUpdateUser

path params
uuid string required
UUID of an Involved Party.

Request body (required)
The body should contain all the mandatory attributes of an postal address.


application/json

Schema
Examples
This example has been generated based on the body schema.

{
  "postalAddressUsageType": "STD",
  "countryCode": "BE",
  "countryRegionCode": "BE-BRU",
  "districtName": "Zuidoost",
  "cityName": "Brussels",
  "cityAreaName": "Fratton",
  "regionName": "Brussels",
  "postalCode": "1001AB",
  "streetName": "Rue Royale",
  "houseNumber": "100",
  "houseNumberAddition": "C",
  "buildingName": "HeadOffice",
  "deliveryInformation": "Watch out for the dog",
  "floor": "5",
  "locationUnitNumber": "910",
  "departmentName": "Retail Department",
  "subdepartmentName": "Electronics",
  "poBoxNumber": "112233",
  "streetType": "FR_BOULEVARD",
  "unstructuredAddressLine1": "string",
  "unstructuredAddressLine2": "string",
  "unstructuredAddressLine3": "string",
  "dataSource": "FOS_IT",
  "effectiveDate": "2020-10-10T10:11:12.345+02:00",
  "lastVerificationDate": "2023-05-03T10:11:12.999Z",
  "endDate": "2050-12-12T23:59:59.999+02:00",
  "deliveryFailureReasonType": "ADR_NOT_EXST"
}

Responses

200

400

404

500
200 OK


application/json

Schema
Examples
This example has been generated based on the body schema.

{
  "postalAddress": {
    "postalAddressUsageType": "RSDNT_ADR",
    "countryCode": "IT",
    "countryRegionCode": "IT-RM",
    "districtName": "Zuidoost",
    "cityName": "ROMA",
    "cityAreaName": "Fratton",
    "regionName": "Greater New York",
    "postalCode": "808",
    "streetName": "Rodeo Drive",
    "houseNumber": "123",
    "houseNumberAddition": "A",
    "buildingName": "White House",
    "deliveryInformation": "Watch out for the angry dog",
    "floor": "5",
    "locationUnitNumber": "910",
    "departmentName": "Retail department",
    "subdepartmentName": "Electronics",
    "poBoxNumber": "123",
    "streetType": "ES_CALLE",
    "unstructuredAddressLine1": "Tempura Road",
    "unstructuredAddressLine2": "Big house on the hill",
    "unstructuredAddressLine3": "Third house from the right",
    "deliveryFailureReasonType": "ADR_NOT_EXST",
    "dataSource": "FOS_IT",
    "lastUpdateUser": "OnePam",
    "lastUpdateDate": "2021-04-27T09:11:11.111Z",
    "effectiveDate": "2020-10-10T08:11:12.345Z",
    "lastVerificationDate": "2023-05-03T10:11:12.999Z",
    "endDate": "2050-12-12T21:59:59.999Z"
  },
  "_links": {
    "self": {
      "href": "https://(hostname):(port)/v5/involved-parties/a15f4243-e38b-4d96-af99-9c40c8dd08ab/post-addresses"
    }
  }
}
-------------------------
in one pam repository class create method 
    public CompletableFuture<Void> createPostalAddress(String uuid, CreatePostalAddressRequest payload) {
        try {
            String url = RegkeyEnum.CREATE_POSTAL_ADDRESS.resolveEndpoint(uuid);
            log.info("Calling OnePAM API to create postal address for UUID: {}", uuid);
            Request request = new RichHttpRequestBuilder()
                    .withUrl(url)
                    .withMethod(Method.Patch())
                    .withJsonContent(payload)
                    .withHeader("X-ING-LastUpdateUser", "X-ING-LastUpdateUser")
                    .build();
            return apiClient.apply(request)
                    .thenApply(response -> {
                        if (response.statusCode() >= 200 && response.statusCode() < 300) {
                            log.info("Postal address created successfully for UUID: {}", uuid);
                            return null;
                        } else {
                            log.error("Failed to create postal address. Status: {}", response.statusCode());
                            throw new DataDistributionApiException(
                                    RegkeyEnum.CREATE_POSTAL_ADDRESS,
                                    "Failed to create postal address",
                                    "Status: " + response.statusCode()
                            );
                        }
                    });
        } catch (RichHttpRequestBuilderException e) {
            throw new DataDistributionApiException(
                    RegkeyEnum.CREATE_POSTAL_ADDRESS,
                    "Failed to build request for postal address creation",
                    e.getMessage()
            );
        }
    }
-------------------------
in reg key Enum file api url

    CREATE_POSTAL_ADDRESS("CREATE_POSTAL_ADDRESS", HttpMethod.POST, "https://api.ing.com/v5/involved-parties/{uuid}/postal-addresses"),
