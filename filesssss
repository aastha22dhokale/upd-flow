package com.ing.datadist.api.service;

import com.ing.datadist.api.model.CreateOrganisationUnitRequest;
import com.ing.datadist.api.model.CreateOrganisationUnitNameRequest;
import com.ing.datadist.api.model.InvolvedPartiesOrganisationUnitResponse;
import com.ing.datadist.api.model.UpdateExternalIdentifierOrganisationUnitRequest;
import com.ing.datadist.api.model.OrganisationUnitOrganisationRelationshipRequest;
import com.ing.datadist.configreader.CofaceOpsConfigReader;
import static com.ing.datadist.api.utils.DataDistributionConstants.DATA_SOURCE;
import static com.ing.datadist.api.utils.DataDistributionConstants.LOGICAL_DATA_DOMAIN;
import static com.ing.datadist.api.utils.DataDistributionConstants.LANGUAGE;
import static com.ing.datadist.api.utils.DataDistributionConstants.CHANNEL_OF_ENTRY;
import static com.ing.datadist.api.utils.DataDistributionConstants.ORGANISATION_UNIT_NAME_TYPE;
import static com.ing.datadist.api.utils.DataDistributionConstants.STRUCTURE_TYPE;
import static com.ing.datadist.api.utils.DataDistributionConstants.EXTERNAL_ID_TYPE;
import static com.ing.datadist.api.utils.DataDistributionConstants.EXTERNAL_ID_STATUS;
import static com.ing.datadist.api.utils.DataDistributionConstants.PLACE_OF_ISSUE;
import static com.ing.datadist.api.utils.DataDistributionConstants.ROLE_REASON_TYPE;

import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.time.ZonedDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ExecutionException;

@Service
@Slf4j
public class OrganisationUnitService {

    private final OnePamRepository onePamRepository;
    private final CofaceOpsConfigReader configReader;
    private final AddressService addressService;

    public OrganisationUnitService(OnePamRepository onePamRepository, CofaceOpsConfigReader configReader, AddressService addressService) {
        this.onePamRepository = onePamRepository;
        this.configReader = configReader;
        this.addressService = addressService;
    }

    public void processOrganisationUnit(String orgNumber) {
        InvolvedPartiesOrganisationUnitResponse response = createOrganisationUnit(orgNumber);
        String uuid = response.getInvolvedPartyIdentifier();
        if (uuid == null || uuid.isBlank()) {
            log.warn("No involvedPartyIdentifier found in response");
            return;
        }

        UpdateExternalIdentifierOrganisationUnitRequest updateRequest = buildUpdateRequest(orgNumber);
        updateExternalIdentifier(uuid, updateRequest);
        addressService.createPostalAddress(uuid, orgNumber);

    }

    private InvolvedPartiesOrganisationUnitResponse createOrganisationUnit(String orgNumber) {
        List<Map<String, String>> configs = configReader.fetchByOrgNumber(orgNumber);
        Map<String, String> config = configs.isEmpty() ? Collections.emptyMap() : configs.get(0);

        String orgUnitName = config.get("organisationUnitName");
        String countryOfResidence = config.get("countryOfResidence");
        String effectiveDate = config.get("dateOfIssue");

        if (orgUnitName == null || orgNumber == null || countryOfResidence == null || effectiveDate == null) {
            log.warn("Missing config values for organisation unit: {}", orgNumber);
            throw new RuntimeException("Missing config for organisation unit");
        }

        CreateOrganisationUnitRequest request = CreateOrganisationUnitRequest.builder()
                .dataSource(DATA_SOURCE)
                .logicalDataDomain(LOGICAL_DATA_DOMAIN)
                .countryOfResidence(countryOfResidence)
                .preferredLanguage(LANGUAGE)
                .channelOfEntry(CHANNEL_OF_ENTRY)
                .organisationUnitStructureType(STRUCTURE_TYPE)
                .effectiveDate(effectiveDate)
                .organisationUnitNames(Collections.singletonList(
                        CreateOrganisationUnitNameRequest.builder()
                                .organisationUnitNameType(ORGANISATION_UNIT_NAME_TYPE)
                                .organisationUnitName(orgUnitName)
                                .build()))
                .build();

        try {
            return onePamRepository.createInvolvedParty(request).get();
        } catch (InterruptedException | ExecutionException e) {
            log.error("Failed to create organisation unit", e);
            Thread.currentThread().interrupt();
            throw new RuntimeException("Creation failed", e);
        }
    }

    private UpdateExternalIdentifierOrganisationUnitRequest buildUpdateRequest(String orgNumber) {
        List<Map<String, String>> configs = configReader.fetchByOrgNumber(orgNumber);
        Map<String, String> config = configs.isEmpty() ? Collections.emptyMap() : configs.get(0);

        String uuid = config.get("uuid");
        String countryOfIssue = config.get("countryOfResidence");
        String dateOfIssue = config.get("dateOfIssue");
        String expiryDate = config.get("expiryDate");

        if (uuid == null || countryOfIssue == null || dateOfIssue == null || expiryDate == null) {
            log.warn("Missing config values for external identifier update: {}", orgNumber);
            throw new RuntimeException("Missing config for external identifier update");
        }

        return UpdateExternalIdentifierOrganisationUnitRequest.builder()
                .involvedPartyExternalIdentifierType(EXTERNAL_ID_TYPE)
                .involvedPartyExternalIdentifierValue(uuid)
                .involvedPartyExternalIdentifierStatusType(EXTERNAL_ID_STATUS)
                .countryOfIssue(countryOfIssue)
                .placeOfIssue(PLACE_OF_ISSUE)
                .dateOfIssue(dateOfIssue)
                .expiryDate(expiryDate)
                .dataSource(DATA_SOURCE)
                .effectiveDate(dateOfIssue)
                .endDate(ZonedDateTime.now().plusYears(10).format(DateTimeFormatter.ISO_OFFSET_DATE_TIME))
                .build();
    }

    private void updateExternalIdentifier(String uuid, UpdateExternalIdentifierOrganisationUnitRequest request) {
        try {
            onePamRepository.updateExternalIdentifier(uuid, request).get();
            log.info("Successfully updated external identifier for UUID: {}", uuid);
        } catch (InterruptedException | ExecutionException e) {
            log.error("Failed to update external identifier", e);
            Thread.currentThread().interrupt();
            throw new RuntimeException("Update failed", e);
        }
    }

    private void createOrganisationUnitHierarchy(String childId, String parentId) {
        OrganisationUnitOrganisationRelationshipRequest request = OrganisationUnitOrganisationRelationshipRequest.builder()
                .childOrganisationUnitIdentifier(childId)
                .parentOrganisationIdentifier(parentId)
                .parentRoleReasonType(ROLE_REASON_TYPE)
                .dataSource(DATA_SOURCE)
                .build();

        try {
            onePamRepository.createOrganisationUnitHierarchy(request).get();
            log.info("Successfully created hierarchy between child: {} and parent: {}", childId, parentId);
        } catch (InterruptedException | ExecutionException e) {
            log.error("Failed to create organisation unit hierarchy", e);
            Thread.currentThread().interrupt();
            throw new RuntimeException("Hierarchy creation failed", e);
        }
    }

}


dd-new
.idea
P33558-DataDistributorAPI
DataDistribution
src
main
java
com
ing
datadist
api
config
InvolvedPartyApiProperties.java
exception
DataDistributionApiException.java
model
CreateInternalIdentifierRequest.java
CreateOrganisationUnitNameRequest.java
CreateOrganisationUnitRequest.java
CreateOrganisationUnitResponse.java
CreatePostalAddressRequest.java
DigitalAddressResponse.java
ErrorResponse.java
GroupResponse.java
InnerErrorResponse.java
InternalIdentifierResponse.java
InvolvedPartiesLinkHrefResponse.java
InvolvedPartiesLinkSelfResponse.java
InvolvedPartiesOrganisationUnitResponse.java
ManagingEntityResponse.java
OrganisationNameResponse.java
OrganisationUnit.java
OrganisationUnitNameResponse.java
OrganisationUnitOrganisationRelationshipRequest.java
OrganisationUnitOrganisationRelationshipResponse.java
PostalAddressResponse.java
SearchChitizenshipResponseV1.java
SearchIndividualNameResponseV1.java
SearchIndividualResponseV1.java
SearchInvolvedPartiesOrganisationUnitRequestV1.java
SearchInvolvedPartiesRequestV1.java
SearchInvolvedPartiesResponseV1.java
SearchOrganisationResponseV1.java
SearchOrganisationUnitAddressResponseV1.java
SearchOrganisationUnitAddressResponseV2.java
SearchOrganisationUnitDigitalAddressesV1.java
SearchOrganisationUnitDigitalAddressesV2.java
SearchOrganisationUnitExternalIdentifierResponseV1.java
SearchOrganisationUnitExternalIdentifierResponseV2.java
SearchOrganisationUnitInternalIdentifierResponseV1.java
SearchOrganisationUnitInternalIdentifierResponseV2.java
SearchOrganisationUnitInvolvedPartyTypeResponseV2.java
SearchOrganisationUnitListResponseV2.java
SearchOrganisationUnitNameResponseV1.java
SearchOrganisationUnitNameResponseV2.java
SearchOrganisationUnitResponseV1.java
SearchOrganisationUnitResponseV2.java
UpdateExternalIdentifierOrganisationUnitRequest.java
UpdateExternalIdentifierOrganisationUnitResponse.java
UpdateInvolvedPartyIndividualNamesResponseV5.java
UpdateInvolvedPartyIndividualRequestV5.java
UpdateInvolvedPartyIndividualResponseV5.java
UpdateInvolvedPartyInternalIdentifierResponseV5.java
UpdateInvolvedPartyOrganisationRequestV5.java
UpdateInvolvedPartyOrganisationResponseV5.java
UpdateInvolvedPartyOrganisationUnitRequestV5.java
UpdateInvolvedPartyOrganisationUnitResponseV5.java
UpdateInvolvedPartyRequestV5.java
UpdateInvolvedPartyResponseV5.java
UpdateOrganisationUnitNameV5Request.java
UpdateOrganisationUnitNameV5Response.java
service
AddressService.java
OnePamRepository.java
OrganisationUnitSearchService.java
OrganisationUnitService.java
PhoenixDiscoveryService.java
UpdateOrganisationUnitService.java
utils
DataDistributionConstants.java
RegkeyEnum.java
HeartbeatController.java
batch
config
processor
repository
schedular
tasklet
OnePamSearchApiTasklet.java
configreader
domain
ecs
kafka
DataDistributionApplication.java
resources
avro
NotifyDigitalAddress5Event.avsc
NotifyIndustryClassification5Event.avsc
NotifyInvolvedPartyExternalIdentifier5Event.avsc
NotifyInvolvedPartyInternalIdentifier5Event.avsc
notifyorganisationhierarchy5Event.avsc
NotifyOrganisationUnitName5Event.avsc
NotifyOrganization5Event.avsc
NotifyOrganizationUnit5Event.avsc
NotifyPostalAddress5Event.avsc
cofaceOpsData.csv
ddsql.txt
test
target
pom.xml
ichpConf
assembly
src
main
resources
ichp
common-properties
logback-spring.xml
peer-token.jwt
version.properties
tst
properties
dcr
wpr
values.yaml
common-values.yaml
target
pom.xml
LocalConf
src
main
resources
accesstokens.jks
application.yml
http-trust.jks
identity.jks
idtokens.jks
keystore.jks
manifest.jks
manifest.jose
peer-token.jwt
peertokens.jks
pom.xml
monitoring
target
.gitignore
ichp-deployment-nonProd.yml
kingsroadData.yaml
pom.xml
PR-verify-pipeline.yml
README.md
resource.yaml
SonarQube.yaml
touchctl-pipeline.yaml
whitelist.yml
