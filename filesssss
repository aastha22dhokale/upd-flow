package com.ing.datadist.api.service;

import com.ing.datadist.api.model.CreateOrganisationUnitRequest;
import com.ing.datadist.api.model.CreateOrganisationUnitNameRequest;
import com.ing.datadist.api.model.InvolvedPartiesOrganisationUnitResponse;
import com.ing.datadist.api.model.UpdateExternalIdentifierOrganisationUnitRequest;
import com.ing.datadist.api.model.OrganisationUnitOrganisationRelationshipRequest;
import com.ing.datadist.configreader.CofaceOpsConfigReader;
import static com.ing.datadist.api.utils.DataDistributionConstants.DATA_SOURCE;
import static com.ing.datadist.api.utils.DataDistributionConstants.LOGICAL_DATA_DOMAIN;
import static com.ing.datadist.api.utils.DataDistributionConstants.LANGUAGE;
import static com.ing.datadist.api.utils.DataDistributionConstants.CHANNEL_OF_ENTRY;
import static com.ing.datadist.api.utils.DataDistributionConstants.ORGANISATION_UNIT_NAME_TYPE;
import static com.ing.datadist.api.utils.DataDistributionConstants.STRUCTURE_TYPE;
import static com.ing.datadist.api.utils.DataDistributionConstants.EXTERNAL_ID_TYPE;
import static com.ing.datadist.api.utils.DataDistributionConstants.EXTERNAL_ID_STATUS;
import static com.ing.datadist.api.utils.DataDistributionConstants.PLACE_OF_ISSUE;
import static com.ing.datadist.api.utils.DataDistributionConstants.ROLE_REASON_TYPE;

import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.time.ZonedDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ExecutionException;

@Service
@Slf4j
public class OrganisationUnitService {

    private final OnePamRepository onePamRepository;
    private final CofaceOpsConfigReader configReader;
    private final AddressService addressService;

    public OrganisationUnitService(OnePamRepository onePamRepository, CofaceOpsConfigReader configReader, AddressService addressService) {
        this.onePamRepository = onePamRepository;
        this.configReader = configReader;
        this.addressService = addressService;
    }

    public void processOrganisationUnit(String orgNumber) {
        InvolvedPartiesOrganisationUnitResponse response = createOrganisationUnit(orgNumber);
        String uuid = response.getInvolvedPartyIdentifier();
        if (uuid == null || uuid.isBlank()) {
            log.warn("No involvedPartyIdentifier found in response");
            return;
        }

        UpdateExternalIdentifierOrganisationUnitRequest updateRequest = buildUpdateRequest(orgNumber);
        updateExternalIdentifier(uuid, updateRequest);
        addressService.createPostalAddress(uuid, orgNumber);

    }

    private InvolvedPartiesOrganisationUnitResponse createOrganisationUnit(String orgNumber) {
        List<Map<String, String>> configs = configReader.fetchByOrgNumber(orgNumber);
        Map<String, String> config = configs.isEmpty() ? Collections.emptyMap() : configs.get(0);

        String orgUnitName = config.get("organisationUnitName");
        String countryOfResidence = config.get("countryOfResidence");
        String effectiveDate = config.get("dateOfIssue");

        if (orgUnitName == null || orgNumber == null || countryOfResidence == null || effectiveDate == null) {
            log.warn("Missing config values for organisation unit: {}", orgNumber);
            throw new RuntimeException("Missing config for organisation unit");
        }

        CreateOrganisationUnitRequest request = CreateOrganisationUnitRequest.builder()
                .dataSource(DATA_SOURCE)
                .logicalDataDomain(LOGICAL_DATA_DOMAIN)
                .countryOfResidence(countryOfResidence)
                .preferredLanguage(LANGUAGE)
                .channelOfEntry(CHANNEL_OF_ENTRY)
                .organisationUnitStructureType(STRUCTURE_TYPE)
                .effectiveDate(effectiveDate)
                .organisationUnitNames(Collections.singletonList(
                        CreateOrganisationUnitNameRequest.builder()
                                .organisationUnitNameType(ORGANISATION_UNIT_NAME_TYPE)
                                .organisationUnitName(orgUnitName)
                                .build()))
                .build();

        try {
            return onePamRepository.createInvolvedParty(request).get();
        } catch (InterruptedException | ExecutionException e) {
            log.error("Failed to create organisation unit", e);
            Thread.currentThread().interrupt();
            throw new RuntimeException("Creation failed", e);
        }
    }

    private UpdateExternalIdentifierOrganisationUnitRequest buildUpdateRequest(String orgNumber) {
        List<Map<String, String>> configs = configReader.fetchByOrgNumber(orgNumber);
        Map<String, String> config = configs.isEmpty() ? Collections.emptyMap() : configs.get(0);

        String uuid = config.get("uuid");
        String countryOfIssue = config.get("countryOfResidence");
        String dateOfIssue = config.get("dateOfIssue");
        String expiryDate = config.get("expiryDate");

        if (uuid == null || countryOfIssue == null || dateOfIssue == null || expiryDate == null) {
            log.warn("Missing config values for external identifier update: {}", orgNumber);
            throw new RuntimeException("Missing config for external identifier update");
        }

        return UpdateExternalIdentifierOrganisationUnitRequest.builder()
                .involvedPartyExternalIdentifierType(EXTERNAL_ID_TYPE)
                .involvedPartyExternalIdentifierValue(uuid)
                .involvedPartyExternalIdentifierStatusType(EXTERNAL_ID_STATUS)
                .countryOfIssue(countryOfIssue)
                .placeOfIssue(PLACE_OF_ISSUE)
                .dateOfIssue(dateOfIssue)
                .expiryDate(expiryDate)
                .dataSource(DATA_SOURCE)
                .effectiveDate(dateOfIssue)
                .endDate(ZonedDateTime.now().plusYears(10).format(DateTimeFormatter.ISO_OFFSET_DATE_TIME))
                .build();
    }

    private void updateExternalIdentifier(String uuid, UpdateExternalIdentifierOrganisationUnitRequest request) {
        try {
            onePamRepository.updateExternalIdentifier(uuid, request).get();
            log.info("Successfully updated external identifier for UUID: {}", uuid);
        } catch (InterruptedException | ExecutionException e) {
            log.error("Failed to update external identifier", e);
            Thread.currentThread().interrupt();
            throw new RuntimeException("Update failed", e);
        }
    }

    private void createOrganisationUnitHierarchy(String childId, String parentId) {
        OrganisationUnitOrganisationRelationshipRequest request = OrganisationUnitOrganisationRelationshipRequest.builder()
                .childOrganisationUnitIdentifier(childId)
                .parentOrganisationIdentifier(parentId)
                .parentRoleReasonType(ROLE_REASON_TYPE)
                .dataSource(DATA_SOURCE)
                .build();

        try {
            onePamRepository.createOrganisationUnitHierarchy(request).get();
            log.info("Successfully created hierarchy between child: {} and parent: {}", childId, parentId);
        } catch (InterruptedException | ExecutionException e) {
            log.error("Failed to create organisation unit hierarchy", e);
            Thread.currentThread().interrupt();
            throw new RuntimeException("Hierarchy creation failed", e);
        }
    }


}
package com.ing.datadist.api.service;
import com.ing.datadist.api.model.*;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import java.util.concurrent.ExecutionException;

@Service
@Slf4j
public class OrganisationUnitSearchService {
    private final OnePamRepository onePamRepository;
    public OrganisationUnitSearchService(OnePamRepository onePamRepository) {
        this.onePamRepository = onePamRepository;
    }
    public SearchInvolvedPartiesResponseV1 searchOrganisationUnitByInternalIdentifier(String type, String value) {
        log.info("searchOrganisationUnitByInternalIdentifier request payload: {} type:{}", value, type);
        SearchInvolvedPartiesRequestV1 request = SearchInvolvedPartiesRequestV1.builder()
                .organisationUnit(SearchInvolvedPartiesOrganisationUnitRequestV1.builder()
                        .involvedPartyInternalIdentifier(CreateInternalIdentifierRequest.builder()
                                .involvedPartyInternalIdentifierValue(value)
                                .involvedPartyInternalIdentifierType(type)
                                .build())
                        .build())
                .build();
        try {
            return onePamRepository.searchInvolvedPartyByInternalIdentifier(request).get();
        } catch (InterruptedException | ExecutionException e) {
            log.error("Failed to search organisation unit by internal identifier", e);
            Thread.currentThread().interrupt();
            throw new RuntimeException("search organisation unit by internal identifier failed", e);
        }
    }
}

package com.ing.datadist.api.service;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.ing.apisdk.toolkit.connectivity.api.JavaService;
import com.ing.apisdk.toolkit.connectivity.transport.http.japi.RichHttpRequestBuilder;
import com.ing.apisdk.toolkit.connectivity.transport.http.japi.RichHttpRequestBuilderException;
import com.ing.datadist.api.config.InvolvedPartyApiProperties;
import com.ing.datadist.api.exception.DataDistributionApiException;
import com.ing.datadist.api.model.*;
import com.ing.datadist.api.utils.RegkeyEnum;
import com.twitter.finagle.http.Method;
import com.twitter.finagle.http.Request;
import com.twitter.finagle.http.Response;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.stereotype.Component;
import scala.collection.JavaConverters;
import java.util.Map;
import java.util.concurrent.CompletableFuture;

@Slf4j
@Component
public class OnePamRepository {
    private final JavaService<Request, Response> apiClient;
    private final ObjectMapper objectMapper;
    private final InvolvedPartyApiProperties apiProperties;
    public OnePamRepository(@Qualifier("integrationServiceGeneric") JavaService<Request, Response> apiClient,
                            ObjectMapper objectMapper,
                            InvolvedPartyApiProperties apiProperties) {
        this.apiClient = apiClient;
        this.objectMapper = objectMapper;
        this.apiProperties = apiProperties;
    }

    public CompletableFuture<InvolvedPartiesOrganisationUnitResponse> createInvolvedParty(CreateOrganisationUnitRequest payload) {
        try {
            String url = RegkeyEnum.CREATE_INVOLVED_PARTY.endpoint;
            Request request = new RichHttpRequestBuilder()
                    .withUrl(url)
                    .withMethod(Method.Post())
                    .withJsonContent(payload)
                    .withHeader("X-ING-LastUpdateUse", "IN_ADMIN")
                    .build();
            return apiClient.apply(request)
                    .thenApply(response -> {
                        try {
                            return objectMapper.readValue(response.contentString(), InvolvedPartiesOrganisationUnitResponse.class);
                        } catch (Exception e) {
                            throw new DataDistributionApiException(
                                    RegkeyEnum.CREATE_INVOLVED_PARTY,
                                    "Failed to parse response from Involved Party API",
                                    e.getMessage()
                            );
                        }
                    });
        } catch (RichHttpRequestBuilderException e) {
            throw new DataDistributionApiException(
                    RegkeyEnum.CREATE_INVOLVED_PARTY,
                    "Failed to build request for create involved party API",
                    e.getMessage()
            );
        }
    }

    public CompletableFuture<Void> updateExternalIdentifier(String uuid, UpdateExternalIdentifierOrganisationUnitRequest payload) {
        try {
            String url = RegkeyEnum.UPDATE_EXTERNAL_IDENTIFIER.resolveEndpoint(uuid);
            Request request = new RichHttpRequestBuilder()
                    .withUrl(url)
                    .withMethod(Method.Post())
                    .withJsonContent(payload)
                    .withHeader("X-ING-LastUpdateUse", "IN_ADMIN")
                    .build();
            return apiClient.apply(request)
                    .thenApply(response -> {
                        if (response.statusCode() >= 200 && response.statusCode() < 300) {
                            return null;
                        } else {
                            throw new DataDistributionApiException(
                                    RegkeyEnum.UPDATE_EXTERNAL_IDENTIFIER,
                                    "Failed to update external identifier",
                                    "Status: " + response.statusCode()
                            );
                        }
                    });
        } catch (RichHttpRequestBuilderException e) {
            throw new DataDistributionApiException(
                    RegkeyEnum.UPDATE_EXTERNAL_IDENTIFIER,
                    "Failed to build request for update external identifier API",
                    e.getMessage()
            );
        }

    }

    public CompletableFuture<Void> createOrganisationUnitHierarchy(OrganisationUnitOrganisationRelationshipRequest payload) {
        try {
            String url = RegkeyEnum.CREATE_ORGANISATION_UNIT_HIERARCHY.endpoint;
            Request request = new RichHttpRequestBuilder()
                    .withUrl(url)
                    .withMethod(Method.Post())
                    .withJsonContent(payload)
                    .withHeader("X-ING-LastUpdateUse", "IN_ADMIN")
                    .build();
            return apiClient.apply(request)
                    .thenApply(response -> {
                        if (response.statusCode() >= 200 && response.statusCode() < 300) {
                            return null;
                        } else {
                            throw new DataDistributionApiException(
                                    RegkeyEnum.CREATE_ORGANISATION_UNIT_HIERARCHY,
                                    "Failed to create organisation unit hierarchy",
                                    "Status: " + response.statusCode()
                            );
                        }
                    });
        } catch (RichHttpRequestBuilderException e) {
            throw new DataDistributionApiException(
                    RegkeyEnum.CREATE_ORGANISATION_UNIT_HIERARCHY,
                    "Failed to build request for organisation unit hierarchy API",
                    e.getMessage()
            );
        }
    }

    public CompletableFuture<SearchInvolvedPartiesResponseV1> searchInvolvedPartyByInternalIdentifier(SearchInvolvedPartiesRequestV1 payload) {
        try {
            String url = RegkeyEnum.SEARCH_ORGANISATION_UNIT.endpoint;  // ✅ dynamically from enum
            log.info("searchInvolvedPartyByInternalIdentifier request payload: {}", payload);
            String jsonPayload = objectMapper.writeValueAsString(payload);
            Request request = new RichHttpRequestBuilder()
                    .withUrl(url)
                    .withMethod(Method.Post())
                    .withJsonContent(jsonPayload)
                    .withHeader("Content-Type", "application/json")
                    .build();
            printRequest(request);
            return apiClient.apply(request)
                    .thenApply(response -> {
                        try {
                            log.info("searchInvolvedPartyByInternalIdentifier response: {}", response);
                            return objectMapper.readValue(response.contentString(), SearchInvolvedPartiesResponseV1.class);
                        } catch (Exception e) {
                            log.error("searchInvolvedPartyByInternalIdentifier error: {}", e.getMessage());
                            throw new DataDistributionApiException(
                                    RegkeyEnum.SEARCH_ORGANISATION_UNIT,
                                    "Failed to parse response from search organisation unit API",
                                    e.getMessage()
                            );
                        }
                    });
        } catch (Exception e) {
            log.error("searchInvolvedPartyByInternalIdentifier API error: {}", e.getMessage());
            throw new DataDistributionApiException(
                    RegkeyEnum.SEARCH_ORGANISATION_UNIT,
                    "Failed to build request for search organisation unit API",
                    e.getMessage()
            );
        }
    }

    public CompletableFuture<UpdateOrganisationUnitNameV5Response> updateOrganisationUnitName(
            UpdateOrganisationUnitNameV5Request payload, String uuid, String nameType) {
        try {
            String url = RegkeyEnum.UPDATE_ORGANISATION_UNIT_NAME.resolveEndpoint(uuid, nameType);
            Request request = new RichHttpRequestBuilder()
                    .withUrl(url)
                    .withMethod(Method.Patch())
                    .withJsonContent(payload)
                    .withHeader("X-ING-LastUpdateUser", "X-ING-LastUpdateUser")
                    .build();
            return apiClient.apply(request)
                    .thenApply(response -> {
                        try {
                            return objectMapper.readValue(response.contentString(), UpdateOrganisationUnitNameV5Response.class);
                        } catch (Exception e) {
                            throw new DataDistributionApiException(
                                    RegkeyEnum.UPDATE_ORGANISATION_UNIT_NAME,
                                    "Failed to parse response from updateOrganisationUnitName API",
                                    e.getMessage()
                            );
                        }
                    });
        } catch (RichHttpRequestBuilderException e) {
            throw new DataDistributionApiException(
                    RegkeyEnum.UPDATE_ORGANISATION_UNIT_NAME,
                    "Failed to build request for updateOrganisationUnitName API",
                    e.getMessage()
            );
        }
    }

    public CompletableFuture<UpdateInvolvedPartyResponseV5> updateInvolvedParty(UpdateInvolvedPartyRequestV5 payload, String uuid) {
        try {
            String url = RegkeyEnum.UPDATE_INVOLVED_PARTY.resolveEndpoint(uuid);
            Request request = new RichHttpRequestBuilder()
                    .withUrl(url)
                    .withMethod(Method.Patch())
                    .withJsonContent(payload)
                    .withHeader("X-ING-LastUpdateUser", "X-ING-LastUpdateUser")
                    .build();
            return apiClient.apply(request)
                    .thenApply(response -> {
                        try {
                            return objectMapper.readValue(response.contentString(), UpdateInvolvedPartyResponseV5.class);
                        } catch (Exception e) {
                            throw new DataDistributionApiException(
                                    RegkeyEnum.UPDATE_INVOLVED_PARTY,
                                    "Failed to parse response for Update InvolvedParty Request API",
                                    e.getMessage()
                            );
                        }
                    });
        } catch (RichHttpRequestBuilderException e) {
            throw new DataDistributionApiException(
                    RegkeyEnum.UPDATE_INVOLVED_PARTY,
                    "Failed to build request for Update InvolvedParty Request API",
                    e.getMessage()
            );
        }
    }

    private static void printRequest(Request req) {
        try {
            log.info("----- Request Details -----");
            log.info("Method: {}", req.method());
            log.info("URI: {}", req.uri());
            log.info("Version: {}", req.version());
            Map<String, String> headerMap = JavaConverters.mapAsJavaMapConverter(req.headerMap()).asJava();
            for (Map.Entry<String, String> entry : headerMap.entrySet()) {
                log.info("Header: {}: {}", entry.getKey(), entry.getValue());
            }
            log.info("Body: {}", req.contentString());
            log.info("---------------------------");
        } catch (Exception e) {
            log.error("Exception while printing request", e);
        }
    }

    public CompletableFuture<Void> createPostalAddress(String uuid, CreatePostalAddressRequest payload) {
        try {
            String url = RegkeyEnum.CREATE_POSTAL_ADDRESS.resolveEndpoint(uuid);
            log.info("Calling OnePAM API to create postal address for UUID: {}", uuid);
            Request request = new RichHttpRequestBuilder()
                    .withUrl(url)
                    .withMethod(Method.Patch())
                    .withJsonContent(payload)
                    .withHeader("X-ING-LastUpdateUser", "X-ING-LastUpdateUser")
                    .build();
            return apiClient.apply(request)
                    .thenApply(response -> {
                        if (response.statusCode() >= 200 && response.statusCode() < 300) {
                            log.info("Postal address created successfully for UUID: {}", uuid);
                            return null;
                        } else {
                            log.error("Failed to create postal address. Status: {}", response.statusCode());
                            throw new DataDistributionApiException(
                                    RegkeyEnum.CREATE_POSTAL_ADDRESS,
                                    "Failed to create postal address",
                                    "Status: " + response.statusCode()
                            );
                        }
                    });
        } catch (RichHttpRequestBuilderException e) {
            throw new DataDistributionApiException(
                    RegkeyEnum.CREATE_POSTAL_ADDRESS,
                    "Failed to build request for postal address creation",
                    e.getMessage()
            );
        }
    }
}
package com.ing.datadist.api.service;
import com.ing.datadist.api.model.CreatePostalAddressRequest;
import com.ing.datadist.configreader.CofaceOpsConfigReader;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import java.time.ZonedDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ExecutionException;
import static com.ing.datadist.api.utils.DataDistributionConstants.DATA_SOURCE;

@Service
@Slf4j
public class AddressService {
    private final CofaceOpsConfigReader configReader;
    private final OnePamRepository onePamRepository;
    public AddressService(CofaceOpsConfigReader configReader, OnePamRepository onePamRepository) {
        this.configReader = configReader;
        this.onePamRepository = onePamRepository;
    }
    public void createPostalAddress(String uuid, String orgNumber) {
        log.info("Starting postal address creation for orgNumber: {} and uuid: {}", orgNumber, uuid);
        List<Map<String, String>> configs = configReader.fetchByOrgNumber(orgNumber);
        if (configs.isEmpty()) {
            log.warn("No config found for orgNumber: {}", orgNumber);
            return;
        }

        Map<String, String> config = configs.get(0);
        CreatePostalAddressRequest request = CreatePostalAddressRequest.builder()
                .postalAddressUsageType("STD")
                .countryCode(config.get("countryOfResidence"))
                .cityName(config.get("cityName"))
                .streetName(config.get("streetName"))
                .houseNumber(config.get("houseNumber"))
                .houseNumberAddition(config.get("houseNumberAddition"))
                .postalCode(config.get("postalCode"))
                .dataSource(DATA_SOURCE)
                .effectiveDate(ZonedDateTime.now().format(DateTimeFormatter.ISO_OFFSET_DATE_TIME))
                .endDate(ZonedDateTime.now().plusYears(10).format(DateTimeFormatter.ISO_OFFSET_DATE_TIME))
                .build();
        try {
            onePamRepository.createPostalAddress(uuid, request).get();
            log.info(" Successfully created postal address for UUID: {}", uuid);
        } catch (InterruptedException | ExecutionException e) {
            log.error(" Failed to create postal address for UUID: {}", uuid, e);
            Thread.currentThread().interrupt();
            throw new RuntimeException("Postal address creation failed", e);
        }
    }


}
package com.ing.datadist.api.service;

import com.ing.datadist.api.model.*;
import com.ing.datadist.domain.OrganisationUnitDomainWrapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Objects;

@Service
@Slf4j
public class UpdateOrganisationUnitService {

    public void updateOrganisationUnit(OrganisationUnitDomainWrapper wrapper, SearchInvolvedPartiesResponseV1 response) throws Exception {

        String uuid = wrapper.getOpsUUID();
        List<SearchOrganisationUnitResponseV1> organisationUnits = response.getOrganisationUnits();


        for (SearchOrganisationUnitResponseV1 organisationUnit : organisationUnits) {
            List<SearchOrganisationUnitNameResponseV1> organisationUnitNames = organisationUnit.getOrganisationUnitNames();
            List<SearchOrganisationUnitAddressResponseV1> postalAddresses = organisationUnit.getPostalAddresses();
            List<SearchOrganisationUnitDigitalAddressesV1> digitalAddresses = organisationUnit.getDigitalAddresses();

            for (SearchOrganisationUnitNameResponseV1 name : organisationUnitNames) {
                if (Objects.equals(wrapper.getOrganisationUnitName(), name.getOrganisationUnitName())) {
                    log.info("Update organisationUnit name changed for uuid:{} old:{} new:{} ", uuid, wrapper.getOrganisationUnitName(), name.getOrganisationUnitName());
                    //Call update name API
                }
            }

            for (SearchOrganisationUnitAddressResponseV1 address : postalAddresses) {
                if (Objects.equals(wrapper.getPostalAddressStreetNm(), address.getStreetName())) {
                    log.info("Update organisationUnit StreetName changed for uuid:{} old:{} new:{} ", uuid, wrapper.getPostalAddressStreetNm(), address.getStreetName());
                    //Call update postal addr API
                }

                if (Objects.equals(wrapper.getPostalAddressHouseNum(), address.getHouseNumber())) {
                    log.info("Update organisationUnit HouseNum changed for uuid:{} old:{} new:{} ", uuid, wrapper.getPostalAddressHouseNum(), address.getHouseNumber());
                    //Call update postal addr API
                }

                if (Objects.equals(wrapper.getPostalAddressHouseAdd(), address.getHouseNumberAddition())) {
                    log.info("Update organisationUnit HouseAdd changed for uuid:{} old:{} new:{} ", uuid, wrapper.getPostalAddressHouseAdd(), address.getHouseNumberAddition());
                    //Call update postal addr API
                }

                if (Objects.equals(wrapper.getPostalAddressPostalCd(), address.getPostalCode())) {
                    log.info("Update organisationUnit PostalCode changed for uuid:{} old:{} new:{} ", uuid, wrapper.getPostalAddressPostalCd(), address.getPostalCode());
                    //Call update postal addr API
                }

                if (Objects.equals(wrapper.getPostalAddressCityName(), address.getCityName())) {
                    log.info("Update organisationUnit CityName changed for uuid:{} old:{} new:{} ", uuid, wrapper.getPostalAddressCityName(), address.getCityName());
                    //Call update postal addr API
                }

                if (Objects.equals(wrapper.getPostalAddressCntryCd(), address.getCountryCode())) {
                    log.info("Update organisationUnit CountryCode changed for uuid:{} old:{} new:{} ", uuid, wrapper.getPostalAddressCntryCd(), address.getCountryCode());
                    //Call update postal addr API
                }
            }

            for (SearchOrganisationUnitDigitalAddressesV1 digitalAddress : digitalAddresses) {
                if (Objects.equals(wrapper.getDigitalAddrEmail(), digitalAddress.getFullDigitalAddress())) {
                    log.info("Update organisationUnit FullDigitalAddress changed for uuid:{} old:{} new:{} ", uuid, wrapper.getDigitalAddrEmail(), digitalAddress.getFullDigitalAddress());
                    //Call update digital addr API
                }

                if (Objects.equals(wrapper.getDigitalAddrFullTefgn(), digitalAddress.getFullDigitalAddress())) {
                    log.info("Update organisationUnit FullDigitalAddress changed for uuid:{} old:{} new:{} ", uuid, wrapper.getDigitalAddrFullTefgn(), digitalAddress.getFullDigitalAddress());
                    //Call update digital addr API
                }

                if (Objects.equals(wrapper.getDigitalAddrFullTel(), digitalAddress.getFullDigitalAddress())) {
                    log.info("Update organisationUnit FullDigitalAddress changed for uuid:{} old:{} new:{} ", uuid, wrapper.getDigitalAddrFullTel(), digitalAddress.getFullDigitalAddress());
                    //Call update digital addr API
                }
            }

        }
    }
}

package com.ing.datadist.api.utils;

import jakarta.ws.rs.HttpMethod;
import lombok.Generated;
import static org.apache.commons.lang3.StringUtils.SPACE;

@Generated
public enum RegkeyEnum {
    // ✅ OnePam endpoints
    CREATE_INVOLVED_PARTY("CREATE_INVOLVED_PARTY", HttpMethod.POST, "https://api.ing.com/v5/involved-parties"),
    UPDATE_EXTERNAL_IDENTIFIER("UPDATE_EXTERNAL_IDENTIFIER", HttpMethod.POST, "https://api.ing.com/v5/involved-parties/{uuid}/external-identifiers"),
    CREATE_ORGANISATION_UNIT_HIERARCHY("CREATE_ORGANISATION_UNIT_HIERARCHY", HttpMethod.POST, "https://api.ing.com/v1/organisation-hierarchies/relationship"),
    SEARCH_ORGANISATION_UNIT("SEARCH_ORGANISATION_UNIT", HttpMethod.POST, "https://api.ing.com/v2/partyandagreementsearch/involved-parties/organisation-units/search"),
    UPDATE_INVOLVED_PARTY("UPDATE_INVOLVED_PARTY", HttpMethod.PATCH, "https://api.ing.com/v5/involved-parties/{uuid}"),
    CLOSE_ORGANISATION_HIERARCHY_RELATIONSHIP("CLOSE_ORGANISATION_HIERARCHY_RELATIONSHIP", HttpMethod.POST, "https://api.ing.com/v1/organisation-hierarchies/relationship/{uuid}/close"),
    UPDATE_ORGANISATION_UNIT_NAME("UPDATE_ORGANISATION_UNIT_NAME", HttpMethod.POST, "https://api.ing.com/v5/involved-parties/{uuid}/organisation-unit-names "),
    CREATE_POSTAL_ADDRESS("CREATE_POSTAL_ADDRESS", HttpMethod.POST, "https://api.ing.com/v5/involved-parties/{uuid}/postal-addresses");


    public final String label;
    public final String method;
    public final String endpoint;

    RegkeyEnum(String label, String method, String endpoint) {
        this.label = label;
        this.method = method;
        this.endpoint = endpoint;
    }

    /**
     * Dynamically replaces path variables like {uuid} with actual values.
     */
    public String resolveEndpoint(String... values) {
        String resolved = endpoint;
        for (String value : values) {
            resolved = resolved.replaceFirst("\\{[^}]+}", value);
        }
        return resolved;
    }

    @Override
    public String toString() {
        return label + " || " + method + SPACE + endpoint;
    }
}

package com.ing.datadist.configreader;

import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Repository;
import java.util.List;
import java.util.Map;

@Repository
@Slf4j
public class CofaceOpsConfigReader {

    private static final String FETCH_BY_ORG_NUMBER_SQL =
            "SELECT OPS_ORGANISATIONUNITNAME, OPS_NUMBER, ADR_POSTALADDRESS_CNTRYCD, " +
                    "OPS_EXTID_DATEOFISSUE, OPS_EXTID_EXPIRYDATE, OPS_UUID " +
                    "FROM DD_COFACEOPS_TBL WHERE OPS_NUMBER = ?";

    private final JdbcTemplate jdbcTemplate;

    @Autowired
    public CofaceOpsConfigReader(JdbcTemplate jdbcTemplate) {
        this.jdbcTemplate = jdbcTemplate;
    }

    public List<Map<String, String>> fetchByOrgNumber(String orgNumber) {
        log.debug("Start of fetchByOrgNumber");
        log.debug("Fetching organisation unit config for Org Number: '{}'", orgNumber);

        List<Map<String, String>> results = jdbcTemplate.query(
                FETCH_BY_ORG_NUMBER_SQL,
                new Object[]{orgNumber},
                new OrganisationUnitRowMapper()
        );

        log.debug("Fetched {} record(s) from DD_COFACEOPS_TBL by Org Number", results.size());
        results.forEach(row -> log.debug("Row: {}", row));
        log.debug("End of fetchByOrgNumber");
        return results;
    }
}
package com.ing.datadist.configreader;

import org.springframework.jdbc.core.RowMapper;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.HashMap;
import java.util.Map;
import static com.ing.datadist.api.utils.DataDistributionConstants.LOGICAL_DATA_DOMAIN;
import static com.ing.datadist.api.utils.DataDistributionConstants.ORGANISATION_UNIT_NAME_TYPE;

public class OrganisationUnitRowMapper implements RowMapper<Map<String, String>> {
    @Override
    public Map<String, String> mapRow(ResultSet organisationUnitResultSet, int rowNum) throws SQLException {
        Map<String, String> row = new HashMap<>();
        row.put("organisationUnitName", organisationUnitResultSet.getString("OPS_ORGANISATIONUNITNAME"));
        row.put("orgNumber", organisationUnitResultSet.getString("OPS_NUMBER"));
        row.put("countryOfResidence", organisationUnitResultSet.getString("ADR_POSTALADDRESS_CNTRYCD"));
        row.put("dateOfIssue", organisationUnitResultSet.getString("OPS_EXTID_DATEOFISSUE"));
        row.put("expiryDate", organisationUnitResultSet.getString("OPS_EXTID_EXPIRYDATE"));
        row.put("uuid", organisationUnitResultSet.getString("OPS_UUID"));
        row.put("logicalDataDomain", LOGICAL_DATA_DOMAIN);
        row.put("organisationUnitNameType", ORGANISATION_UNIT_NAME_TYPE);
        return row;
    }
}

package com.ing.datadist.domain;

import lombok.Data;

@Data
public class OrganisationUnitDomain {
    private String recordActionType;
    private String orgExternalIdentifierVal;
    private String opsExternalIdentifierVal;
    private String organisationUnitName;
    private String postalAddressStreetNm;
    private String postalAddressHouseNum;
    private String postalAddressHouseAdd;
    private String postalAddressPostalCd;
    private String postalAddressCityName;
    private String postalAddressCntryCd;
    private String opsExtIdDateOfIssue;
    private String opsExtIdExpiryDate;
    private String digitalAddrFullTel;
    private String digitalAddrfFullTefgn;
    private String digitalAddrEmail;

}

package com.ing.datadist.domain;

import lombok.Data;

@Data
public class OrganisationUnitDomainWrapper {
    private String opsUUID;
    private String orgUUID;
    private String orgExternalIdentifierVal;
    private String opsExternalIdentifierVal;
    private String organisationUnitName;
    private String postalAddressStreetNm;
    private String postalAddressHouseNum;
    private String postalAddressHouseAdd;
    private String postalAddressPostalCd;
    private String postalAddressCityName;
    private String postalAddressCntryCd;
    private String opsExtIdDateOfIssue;
    private String opsExtIdExpiryDate;
    private String digitalAddrFullTel;
    private String digitalAddrFullTefgn;
    private String digitalAddrEmail;
    private String recordActionType;
}

package com.ing.datadist.domain;

package com.ing.datadist.domain;

import lombok.Data;
import org.springframework.batch.core.configuration.annotation.JobScope;
import org.springframework.stereotype.Component;

import java.util.ArrayList;
import java.util.List;

@Component
@JobScope
@Data
public class TaskletCofaceOpsDomainWrapper {

    private List<OrganisationUnitDomainWrapper> cofaceOpsDomainWrapper = new ArrayList<OrganisationUnitDomainWrapper>();
}
