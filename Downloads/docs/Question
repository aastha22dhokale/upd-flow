package com.ing.datadist.batch.tasklet;

import com.ing.datadist.api.model.SearchInvolvedPartiesResponseV1;
import com.ing.datadist.api.service.InvolvedPartySearchService;
import com.ing.datadist.api.service.OrganisationUnitService;
import com.ing.datadist.api.service.UpdateOrganisationUnitService;
import com.ing.datadist.domain.OrganisationUnitDomainWrapper;
import com.ing.datadist.domain.TaskletCofaceOpsDomainWrapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.batch.core.StepContribution;
import org.springframework.batch.core.configuration.annotation.StepScope;
import org.springframework.batch.core.scope.context.ChunkContext;
import org.springframework.batch.core.step.tasklet.Tasklet;
import org.springframework.batch.repeat.RepeatStatus;
import org.springframework.stereotype.Component;

import java.util.List;

@Component
@StepScope
@Slf4j
public class OnePamSearchApiTasklet implements Tasklet {

    private final static String UPDATE_ACTION_TYPE = "UPD";
    private final static String DELETE_ACTION_TYPE = "DEL";
    private final static String INSERT_ACTION_TYPE = "INS";

    private final InvolvedPartySearchService searchService;

    private final OrganisationUnitService organisationUnitService;

    private final UpdateOrganisationUnitService updateOrganisationUnitService;


    private final TaskletCofaceOpsDomainWrapper taskletCofaceOpsDomainWrapper;

    public OnePamSearchApiTasklet(InvolvedPartySearchService searchService, OrganisationUnitService organisationUnitService, UpdateOrganisationUnitService updateOrganisationUnitService, TaskletCofaceOpsDomainWrapper taskletCofaceOpsDomainWrapper) {
        this.searchService = searchService;
        this.organisationUnitService = organisationUnitService;
        this.updateOrganisationUnitService = updateOrganisationUnitService;
        this.taskletCofaceOpsDomainWrapper = taskletCofaceOpsDomainWrapper;
    }

    @Override
    public RepeatStatus execute(StepContribution contribution, ChunkContext chunkContext) throws Exception {
        try {
            List<OrganisationUnitDomainWrapper> wrappers = taskletCofaceOpsDomainWrapper.getCofaceOpsDomainWrapper();
            log.info("OnePamSearchApiTasklet wrappers size:" + wrappers.size());

            for (OrganisationUnitDomainWrapper domainWrapper : wrappers) {
                try {
                    String organisationDdUuid = domainWrapper.getOrgUUID();

                    if (organisationDdUuid == null || organisationDdUuid.isEmpty()) {
                        log.info("Skipping wrapper: OrgUUID is null or empty");
                        continue;
                    }

                    SearchInvolvedPartiesResponseV1 organisationResult  = searchService.searchInvolvedPartyByInternalIdentifier("UUID", organisationDdUuid);
                    if (organisationResult != null && organisationResult.getOrganisations() != null) {
                        log.info("Organisation found for UUID: {}", organisationDdUuid);
                        SearchInvolvedPartiesResponseV1 organisationUnitResult = searchService.searchInvolvedPartyByInternalIdentifier("UUID", organisationDdUuid);
                    }

                } catch (Exception e) {
                    log.error("Exception occurred while executing API call for UUID :{} error :{}", domainWrapper.getOpsUUID(), e.getMessage());
                }
            }
        } catch (Exception ex) {
            log.error("Exception occurred while executing OnePamSearchApiTasklet : {}", ex.getMessage());
        }
        return RepeatStatus.FINISHED;
    }
}
