[INFO] /C:/Users/UU47VT/dd-new/P33558-DataDistributorAPI/DataDistribution/src/main/java/com/ing/datadist/configreader/CofaceOpsConfigReader.java: Some input files use or override a deprecated API.
[INFO] /C:/Users/UU47VT/dd-new/P33558-DataDistributorAPI/DataDistribution/src/main/java/com/ing/datadist/configreader/CofaceOpsConfigReader.java: Recompile with -Xlint:deprecation for details.
[INFO] -------------------------------------------------------------
[ERROR] COMPILATION ERROR :
[INFO] -------------------------------------------------------------
[ERROR] /C:/Users/UU47VT/dd-new/P33558-DataDistributorAPI/DataDistribution/src/main/java/com/ing/datadist/api/service/OrganisationUnitService.java:[48,5] variable executor might not have been initialized
[ERROR] /C:/Users/UU47VT/dd-new/P33558-DataDistributorAPI/DataDistribution/src/main/java/com/ing/datadist/batch/tasklet/OnePamSearchApiTasklet.java:[62,48] method processOrganisationUnit in class com.ing.datadist.api.service.OrganisationUnitService cannot be applied to given types;
  required: java.lang.String,java.lang.String
  found:    java.lang.String
  reason: actual and formal argument lists differ in length
[INFO] 2 errors
[INFO] -------------------------------------------------------------
[INFO] ------------------------------------------------------------------------
[INFO] BUILD FAILURE
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  15.190 s
[INFO] Finished at: 2025-11-14T17:47:04+05:30
[INFO] ------------------------------------------------------------------------
[ERROR] Failed to execute goal org.apache.maven.plugins:maven-compiler-plugin:3.14.0:compile (default-compile) on project DataDistribution: Compilation failure: Compilation failure:
[ERROR] /C:/Users/UU47VT/dd-new/P33558-DataDistributorAPI/DataDistribution/src/main/java/com/ing/datadist/api/service/OrganisationUnitService.java:[48,5] variable executor might not have been initialized
[ERROR] /C:/Users/UU47VT/dd-new/P33558-DataDistributorAPI/DataDistribution/src/main/java/com/ing/datadist/batch/tasklet/OnePamSearchApiTasklet.java:[62,48] method processOrganisationUnit in class com.ing.datadist.api.service.OrganisationUnitService cannot be applied to given types;
[ERROR]   required: java.lang.String,java.lang.String
[ERROR]   found:    java.lang.String
[ERROR]   reason: actual and formal argument lists differ in length
[ERROR] -> [Help 1]
[ERROR]
[ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch.
[ERROR] Re-run Maven using the -X switch to enable full debug logging.
[ERROR]
[ERROR] For more information about the errors and possible solutions, please read the following articles:
[ERROR] [Help 1] http://cwiki.apache.org/confluence/display/MAVEN/MojoFailureException
PS C:\Users\UU47VT\dd-new\P33558-DataD

package com.ing.datadist.api.service;

import com.ing.datadist.api.model.CreateOrganisationUnitRequest;
import com.ing.datadist.api.model.CreateOrganisationUnitNameRequest;
import com.ing.datadist.api.model.InvolvedPartiesOrganisationUnitResponse;
import com.ing.datadist.api.model.UpdateExternalIdentifierOrganisationUnitRequest;
import com.ing.datadist.api.model.OrganisationUnitOrganisationRelationshipRequest;
import com.ing.datadist.configreader.CofaceOpsConfigReader;
import static com.ing.datadist.api.utils.DataDistributionConstants.DATA_SOURCE;
import static com.ing.datadist.api.utils.DataDistributionConstants.LOGICAL_DATA_DOMAIN;
import static com.ing.datadist.api.utils.DataDistributionConstants.LANGUAGE;
import static com.ing.datadist.api.utils.DataDistributionConstants.CHANNEL_OF_ENTRY;
import static com.ing.datadist.api.utils.DataDistributionConstants.ORGANISATION_UNIT_NAME_TYPE;
import static com.ing.datadist.api.utils.DataDistributionConstants.STRUCTURE_TYPE;
import static com.ing.datadist.api.utils.DataDistributionConstants.EXTERNAL_ID_TYPE;
import static com.ing.datadist.api.utils.DataDistributionConstants.EXTERNAL_ID_STATUS;
import static com.ing.datadist.api.utils.DataDistributionConstants.PLACE_OF_ISSUE;
import static com.ing.datadist.api.utils.DataDistributionConstants.ROLE_REASON_TYPE;

import java.util.concurrent.CompletableFuture;
import java.util.concurrent.Executor;

import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.time.ZonedDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ExecutionException;

@Service
@Slf4j
public class OrganisationUnitService {

    private final OnePamRepository onePamRepository;
    private final CofaceOpsConfigReader configReader;
    private final AddressService addressService;
    private final Executor executor;


    public OrganisationUnitService(OnePamRepository onePamRepository, CofaceOpsConfigReader configReader, AddressService addressService) {
        this.onePamRepository = onePamRepository;
        this.configReader = configReader;
        this.addressService = addressService;
//        this.executor = executor;
        this.executor = Executors.newFixedThreadPool(5);
    }


    public void processOrganisationUnit(String orgNumber, String parentUuid) {

        // ------------------ STEP 1: Create Organisation Unit (sync) ------------------

        InvolvedPartiesOrganisationUnitResponse response = createOrganisationUnit(orgNumber);

        String childUuid = response.getInvolvedPartyIdentifier();

        if (childUuid == null || childUuid.isBlank()) {

            log.warn("❌ Unable to create Organisation Unit. No child UUID found for orgNumber: {}", orgNumber);

            return;

        }

        log.info("✔ Organisation Unit created. childUuid={}", childUuid);


        // ------------------ STEP 2: First mandatory synchronous updateExternalIdentifier ------------------

        UpdateExternalIdentifierOrganisationUnitRequest updateRequest = buildUpdateRequest(orgNumber);

        updateExternalIdentifier(childUuid, updateRequest);  // sync

        log.info("✔ First updateExternalIdentifier completed for childUuid={}", childUuid);
        // ------------------ STEP 3: Build Hierarchy Payload (NO FETCHING NEEDED) ------------------

        OrganisationUnitOrganisationRelationshipRequest hierarchyPayload =

                OrganisationUnitOrganisationRelationshipRequest.builder()

                        .childOrganisationUnitIdentifier(childUuid)

                        .parentOrganisationIdentifier(parentUuid)  // Already available — no lookup

                        .parentRoleReasonType("LEGAL")

                        .dataSource("ING")

                        .build();


        // ------------------ STEP 4: Execute Remaining 3 Calls in Parallel ------------------

        CompletableFuture<Void> postalAddressFuture =

                CompletableFuture.runAsync(() ->

                                addressService.createPostalAddress(childUuid, orgNumber),

                        executor

                );

        CompletableFuture<Void> hierarchyFuture =

                onePamRepository.createOrganisationUnitHierarchy(hierarchyPayload)

                        .thenAccept(aVoid ->

                                log.info("✔ Hierarchy created: parentUuid={} childUuid={}", parentUuid, childUuid)

                        );

        CompletableFuture<Void> secondUpdateExtIdFuture =

                CompletableFuture.runAsync(() ->

                                updateExternalIdentifier(childUuid, updateRequest),

                        executor

                );


        // ------------------ STEP 5: Wait for All Parallel Operations ------------------

        CompletableFuture.allOf(

                postalAddressFuture,

                hierarchyFuture,

                secondUpdateExtIdFuture

        ).join();

        log.info("✔ All parallel calls completed for childUuid={}", childUuid);

    }




//    public void processOrganisationUnit(String orgNumber) {
//        // ------------------ STEP 1: Create Organisation Unit (sync) ------------------
//        InvolvedPartiesOrganisationUnitResponse response = createOrganisationUnit(orgNumber);
//        String childUuid = response.getInvolvedPartyIdentifier();
//        if (childUuid == null || childUuid.isBlank()) {
//            log.warn("No child UUID found in createOrganisationUnit() response for orgNumber={}", orgNumber);
//            return;
//        }
//        // ------------------ STEP 2: First mandatory synchronous externalIdentifier update ------------------
//        UpdateExternalIdentifierOrganisationUnitRequest updateRequest = buildUpdateRequest(orgNumber);
//        updateExternalIdentifier(childUuid, updateRequest);  // MUST be synchronous
//        log.info("First sync updateExternalIdentifier completed for childUUID={}", childUuid);
//
//        // ------------------ STEP 3: Fetch/derive Parent UUID (Scenario D = already available) ------------------
//        String parentUuid = getParentUuidFromCache(orgNumber);  // Your logic
//        if (parentUuid == null || parentUuid.isBlank()) {
//            log.warn("Parent UUID not found for orgNumber={}. Skipping hierarchy creation.", orgNumber);
//            return;
//        }
//        // Prepare hierarchy payload directly (no fetching required)
//        OrganisationUnitOrganisationRelationshipRequest hierarchyPayload =
//                OrganisationUnitOrganisationRelationshipRequest.builder()
//                        .childOrganisationUnitIdentifier(childUuid)
//                        .parentOrganisationIdentifier(parentUuid)
//                        .parentRoleReasonType("LEGAL") // Optional based on OnePAM config
//                        .dataSource("ING")
//                        .build();
//
//        // ------------------ STEP 4: Remaining 3 calls in PARALLEL ------------------
//        CompletableFuture<Void> createPostalAddressAsync =
//                CompletableFuture.runAsync(() ->
//                                addressService.createPostalAddress(childUuid, orgNumber),
//                        executor
//                );
//        CompletableFuture<Void> createOrganisationUnitHierarchyAsync =
//                onePamRepository.createOrganisationUnitHierarchy(hierarchyPayload)
//                        .thenAccept(v ->
//                                log.info("Hierarchy created → PARENT={}  CHILD={}", parentUuid, childUuid)
//                        );
//        CompletableFuture<Void> updateExternalIdentifierAsync =
//                CompletableFuture.runAsync(() ->
//                                updateExternalIdentifier(childUuid, updateRequest),
//                        executor
//                );
//        // ------------------ STEP 5: Wait for all parallel calls ------------------
//        CompletableFuture.allOf(
//                createPostalAddressAsync,
//                createOrganisationUnitHierarchyAsync,
//                updateExternalIdentifierAsync
//        ).join();
//        log.info("All parallel calls completed successfully for childUUID={}", childUuid);
//    }


//    public void processOrganisationUnit(String orgNumber) {
//
//        // ------------------ STEP 1: Create Organisation Unit (sync) ------------------
//        InvolvedPartiesOrganisationUnitResponse response = createOrganisationUnit(orgNumber);
//
//        String childUuid = response.getInvolvedPartyIdentifier();
//
//        if (childUuid == null || childUuid.isBlank()) {
//            log.warn("No child UUID (involvedPartyIdentifier) found in response for orgNumber: {}", orgNumber);
//            return;
//        }
//
//        // ------------------ STEP 2: First mandatory synchronous call ------------------
//        UpdateExternalIdentifierOrganisationUnitRequest updateRequest = buildUpdateRequest(orgNumber);
//
//        updateExternalIdentifier(childUuid, updateRequest);  // MUST be sync
//        log.info("✔ First sync updateExternalIdentifier completed for UUID: {}", childUuid);
//
//
//        // ------------------ STEP 3: Prepare parent UUID (Scenario D) ------------------
//        // You already have parentUuid from previous step or earlier processing
//        String parentUuid = getParentUuidFromCache(orgNumber); // <-- your logic
//
//        if (parentUuid == null || parentUuid.isBlank()) {
//            log.warn("Parent UUID not found for orgNumber: {}", orgNumber);
//            return;
//        }
//
//        // Build hierarchy payload NOW (no fetching required)
//        OrganisationUnitOrganisationRelationshipRequest hierarchyPayload =
//                OrganisationUnitOrganisationRelationshipRequest.builder()
//                        .childOrganisationUnitIdentifier(childUuid)
//                        .parentOrganisationIdentifier(parentUuid)
//                        .parentRoleReasonType("LEGAL")   // example
//                        .dataSource("ING")
//                        .build();
//
//
//        // ------------------ STEP 4: Run remaining 3 calls in PARALLEL ------------------
//
//        CompletableFuture<Void> addressFuture =
//                CompletableFuture.runAsync(() ->
//                                addressService.createPostalAddress(childUuid, orgNumber),
//                        executor
//                );
//
//        CompletableFuture<Void> hierarchyFuture =
//                onePamRepository.createOrganisationUnitHierarchy(hierarchyPayload)
//                        .thenAccept(res -> log.info("✔ Hierarchy created: child={} parent={}", childUuid, parentUuid));
//
//        CompletableFuture<Void> updateExtId2Future =
//                CompletableFuture.runAsync(() ->
//                                updateExternalIdentifier(childUuid, updateRequest),
//                        executor
//                );
//
//        // ------------------ STEP 5: Wait for ALL 3 parallel calls ------------------
//        CompletableFuture.allOf(addressFuture, hierarchyFuture, updateExtId2Future).join();
//
//        log.info("✔ All parallel calls completed successfully for child UUID: {}", childUuid);
//    }

//    public void processOrganisationUnit(String orgNumber) {
//        InvolvedPartiesOrganisationUnitResponse response = createOrganisationUnit(orgNumber);
//        String uuid = response.getInvolvedPartyIdentifier();
//        if (uuid == null || uuid.isBlank()) {
//            log.warn("No involvedPartyIdentifier found in response");
//            return;
//        }
//
//        UpdateExternalIdentifierOrganisationUnitRequest updateRequest = buildUpdateRequest(orgNumber);
//        updateExternalIdentifier(uuid, updateRequest);
//        addressService.createPostalAddress(uuid, orgNumber);
//
//    }

//    public void processOrganisationUnit(String orgNumber) {
//
//        // ------------------ STEP 1: Create Organisation Unit (sync) ------------------
//        InvolvedPartiesOrganisationUnitResponse response = createOrganisationUnit(orgNumber);
//        String uuid = response.getInvolvedPartyIdentifier();
//        if (uuid == null || uuid.isBlank()) {
//            log.warn("No involvedPartyIdentifier found in response");
//            return;
//        }
//public void processOrganisationUnit(String orgNumber) {
//    // ------------------ STEP 1: Create Organisation Unit (SYNC) ------------------
//    InvolvedPartiesOrganisationUnitResponse response = createOrganisationUnit(orgNumber);
//    String uuid = response.getInvolvedPartyIdentifier();
//    if (uuid == null || uuid.isBlank()) {
//        log.warn("No involvedPartyIdentifier found in OrganisationUnit response for orgNumber: {}", orgNumber);
//        return;
//    }
//    // ------------------ STEP 2: FIRST mandatory synchronous call ------------------
//    UpdateExternalIdentifierOrganisationUnitRequest updateRequest = buildUpdateRequest(orgNumber);
//    updateExternalIdentifier(uuid, updateRequest); // MUST RUN FIRST (SYNC)
//    log.info("✔ Completed mandatory sync updateExternalIdentifier for UUID: {}", uuid);
//    // ------------------ STEP 3: 3 PARALLEL CALLS ------------------
//    CompletableFuture<Void> addressFuture =
//            CompletableFuture.runAsync(() ->
//                            addressService.createPostalAddress(uuid, orgNumber),
//                    executor
//            );
//    CompletableFuture<Void> hierarchyFuture =
//            CompletableFuture.runAsync(() -> {
//                String parentId = getParentId(orgNumber);   // confirm how you fetch parent
//                createOrganisationUnitHierarchy(uuid, parentId);
//            }, executor);
//    CompletableFuture<Void> extId2Future =
//            CompletableFuture.runAsync(() ->
//                            onePamRepository.updateExternalIdentifier(uuid, updateRequest),
//                    executor
//            );
//
//    // ------------------ STEP 4: WAIT FOR ALL PARALLEL CALLS ------------------
//    CompletableFuture.allOf(addressFuture, hierarchyFuture, extId2Future)
//            .join();
//    log.info("✔ All parallel Organisation Unit update calls completed for UUID: {}", uuid);
//}


    private InvolvedPartiesOrganisationUnitResponse createOrganisationUnit(String orgNumber) {
        List<Map<String, String>> configs = configReader.fetchByOrgNumber(orgNumber);
        Map<String, String> config = configs.isEmpty() ? Collections.emptyMap() : configs.get(0);

        String orgUnitName = config.get("organisationUnitName");
        String countryOfResidence = config.get("countryOfResidence");
        String effectiveDate = config.get("dateOfIssue");

        if (orgUnitName == null || orgNumber == null || countryOfResidence == null || effectiveDate == null) {
            log.warn("Missing config values for organisation unit: {}", orgNumber);
            throw new RuntimeException("Missing config for organisation unit");
        }

        CreateOrganisationUnitRequest request = CreateOrganisationUnitRequest.builder()
                .dataSource(DATA_SOURCE)
                .logicalDataDomain(LOGICAL_DATA_DOMAIN)
                .countryOfResidence(countryOfResidence)
                .preferredLanguage(LANGUAGE)
                .channelOfEntry(CHANNEL_OF_ENTRY)
                .organisationUnitStructureType(STRUCTURE_TYPE)
                .effectiveDate(effectiveDate)
                .organisationUnitNames(Collections.singletonList(
                        CreateOrganisationUnitNameRequest.builder()
                                .organisationUnitNameType(ORGANISATION_UNIT_NAME_TYPE)
                                .organisationUnitName(orgUnitName)
                                .build()))
                .build();

        try {
            return onePamRepository.createInvolvedParty(request).get();
        } catch (InterruptedException | ExecutionException e) {
            log.error("Failed to create organisation unit", e);
            Thread.currentThread().interrupt();
            throw new RuntimeException("Creation failed", e);
        }
    }

    private UpdateExternalIdentifierOrganisationUnitRequest buildUpdateRequest(String orgNumber) {
        List<Map<String, String>> configs = configReader.fetchByOrgNumber(orgNumber);
        Map<String, String> config = configs.isEmpty() ? Collections.emptyMap() : configs.get(0);

        String uuid = config.get("uuid");
        String countryOfIssue = config.get("countryOfResidence");
        String dateOfIssue = config.get("dateOfIssue");
        String expiryDate = config.get("expiryDate");

        if (uuid == null || countryOfIssue == null || dateOfIssue == null || expiryDate == null) {
            log.warn("Missing config values for external identifier update: {}", orgNumber);
            throw new RuntimeException("Missing config for external identifier update");
        }

        return UpdateExternalIdentifierOrganisationUnitRequest.builder()
                .involvedPartyExternalIdentifierType(EXTERNAL_ID_TYPE)
                .involvedPartyExternalIdentifierValue(uuid)
                .involvedPartyExternalIdentifierStatusType(EXTERNAL_ID_STATUS)
                .countryOfIssue(countryOfIssue)
                .placeOfIssue(PLACE_OF_ISSUE)
                .dateOfIssue(dateOfIssue)
                .expiryDate(expiryDate)
                .dataSource(DATA_SOURCE)
                .effectiveDate(dateOfIssue)
                .endDate(ZonedDateTime.now().plusYears(10).format(DateTimeFormatter.ISO_OFFSET_DATE_TIME))
                .build();
    }

    private void updateExternalIdentifier(String uuid, UpdateExternalIdentifierOrganisationUnitRequest request) {
        try {
            onePamRepository.updateExternalIdentifier(uuid, request).get();
            log.info("Successfully updated external identifier for UUID: {}", uuid);
        } catch (InterruptedException | ExecutionException e) {
            log.error("Failed to update external identifier", e);
            Thread.currentThread().interrupt();
            throw new RuntimeException("Update failed", e);
        }
    }

    private void createOrganisationUnitHierarchy(String childId, String parentId) {
        OrganisationUnitOrganisationRelationshipRequest request = OrganisationUnitOrganisationRelationshipRequest.builder()
                .childOrganisationUnitIdentifier(childId)
                .parentOrganisationIdentifier(parentId)
                .parentRoleReasonType(ROLE_REASON_TYPE)
                .dataSource(DATA_SOURCE)
                .build();

        try {
            onePamRepository.createOrganisationUnitHierarchy(request).get();
            log.info("Successfully created hierarchy between child: {} and parent: {}", childId, parentId);
        } catch (InterruptedException | ExecutionException e) {
            log.error("Failed to create organisation unit hierarchy", e);
            Thread.currentThread().interrupt();
            throw new RuntimeException("Hierarchy creation failed", e);
        }
    }


}

package com.ing.datadist.batch.tasklet;

import com.ing.datadist.api.model.SearchInvolvedPartiesResponseV1;
import com.ing.datadist.api.model.SearchOrganisationUnitListResponseV2;
import com.ing.datadist.api.service.OrganisationUnitSearchService;
import com.ing.datadist.api.service.OrganisationUnitService;
import com.ing.datadist.api.service.UpdateOrganisationUnitService;
import com.ing.datadist.domain.OrganisationUnitDomainWrapper;
import com.ing.datadist.domain.TaskletCofaceOpsDomainWrapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.batch.core.StepContribution;
import org.springframework.batch.core.configuration.annotation.StepScope;
import org.springframework.batch.core.scope.context.ChunkContext;
import org.springframework.batch.core.step.tasklet.Tasklet;
import org.springframework.batch.repeat.RepeatStatus;
import org.springframework.stereotype.Component;

import java.util.List;

@Component
@StepScope
@Slf4j
public class OnePamSearchApiTasklet implements Tasklet {

    private final static String UPDATE_ACTION_TYPE = "UPD";
    private final static String DELETE_ACTION_TYPE = "DEL";
    private final static String INSERT_ACTION_TYPE = "INS";

    private final OrganisationUnitSearchService searchService;

    private final OrganisationUnitService organisationUnitService;

    private final UpdateOrganisationUnitService updateOrganisationUnitService;


    private final TaskletCofaceOpsDomainWrapper taskletCofaceOpsDomainWrapper;

    public OnePamSearchApiTasklet(OrganisationUnitSearchService searchService, OrganisationUnitService organisationUnitService, UpdateOrganisationUnitService updateOrganisationUnitService, TaskletCofaceOpsDomainWrapper taskletCofaceOpsDomainWrapper) {
        this.searchService = searchService;
        this.organisationUnitService = organisationUnitService;
        this.updateOrganisationUnitService = updateOrganisationUnitService;
        this.taskletCofaceOpsDomainWrapper = taskletCofaceOpsDomainWrapper;
    }

    @Override
    public RepeatStatus execute(StepContribution contribution, ChunkContext chunkContext) throws Exception {
        try {
            List<OrganisationUnitDomainWrapper> wrappers = taskletCofaceOpsDomainWrapper.getCofaceOpsDomainWrapper();
            log.info("OnePamSearchApiTasklet wrappers size:" + wrappers.size());

            for (OrganisationUnitDomainWrapper domainWrapper : wrappers) {
                try {
                    String actionType = domainWrapper.getRecordActionType();
                    if (UPDATE_ACTION_TYPE.equalsIgnoreCase(actionType)) {
                        SearchInvolvedPartiesResponseV1 result = searchService.searchOrganisationUnitByInternalIdentifier("UUID", domainWrapper.getOpsUUID());
                        if (result != null && result.getTotalNumberOfResults() > 0) {
                            updateOrganisationUnitService.updateOrganisationUnit(domainWrapper,result);
                        } else {
                            log.error("searchOrganisationUnit api No data found for UUID {}", domainWrapper.getOpsUUID());
                        }
                    } else if (INSERT_ACTION_TYPE.equalsIgnoreCase(actionType)) {
                        organisationUnitService.processOrganisationUnit(domainWrapper.getOpsUUID());
                    }
                } catch (Exception e) {
                    log.error("Exception occurred while executing API call for UUID :{} error :{}", domainWrapper.getOpsUUID(), e.getMessage());
                }
            }
        } catch (Exception ex) {
            log.error("Exception occurred while executing OnePamSearchApiTasklet : {}", ex.getMessage());
        }
        return RepeatStatus.FINISHED;
    }
}
package com.ing.datadist.api.service;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.ing.apisdk.toolkit.connectivity.api.JavaService;
import com.ing.apisdk.toolkit.connectivity.transport.http.japi.RichHttpRequestBuilder;
import com.ing.apisdk.toolkit.connectivity.transport.http.japi.RichHttpRequestBuilderException;
import com.ing.datadist.api.config.InvolvedPartyApiProperties;
import com.ing.datadist.api.exception.DataDistributionApiException;
import com.ing.datadist.api.model.*;
import com.ing.datadist.api.utils.RegkeyEnum;
import com.twitter.finagle.http.Method;
import com.twitter.finagle.http.Request;
import com.twitter.finagle.http.Response;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.stereotype.Component;
import scala.collection.JavaConverters;
import java.util.Map;
import java.util.concurrent.CompletableFuture;

@Slf4j
@Component
public class OnePamRepository {
    private final JavaService<Request, Response> apiClient;
    private final ObjectMapper objectMapper;
    private final InvolvedPartyApiProperties apiProperties;
    public OnePamRepository(@Qualifier("integrationServiceGeneric") JavaService<Request, Response> apiClient,
                            ObjectMapper objectMapper,
                            InvolvedPartyApiProperties apiProperties) {
        this.apiClient = apiClient;
        this.objectMapper = objectMapper;
        this.apiProperties = apiProperties;
    }

    public CompletableFuture<InvolvedPartiesOrganisationUnitResponse> createInvolvedParty(CreateOrganisationUnitRequest payload) {
        try {
            String url = RegkeyEnum.CREATE_INVOLVED_PARTY.endpoint;
            Request request = new RichHttpRequestBuilder()
                    .withUrl(url)
                    .withMethod(Method.Post())
                    .withJsonContent(payload)
                    .withHeader("X-ING-LastUpdateUse", "IN_ADMIN")
                    .build();
            return apiClient.apply(request)
                    .thenApply(response -> {
                        try {
                            return objectMapper.readValue(response.contentString(), InvolvedPartiesOrganisationUnitResponse.class);
                        } catch (Exception e) {
                            throw new DataDistributionApiException(
                                    RegkeyEnum.CREATE_INVOLVED_PARTY,
                                    "Failed to parse response from Involved Party API",
                                    e.getMessage()
                            );
                        }
                    });
        } catch (RichHttpRequestBuilderException e) {
            throw new DataDistributionApiException(
                    RegkeyEnum.CREATE_INVOLVED_PARTY,
                    "Failed to build request for create involved party API",
                    e.getMessage()
            );
        }
    }

    public CompletableFuture<Void> updateExternalIdentifier(String uuid, UpdateExternalIdentifierOrganisationUnitRequest payload) {
        try {
            String url = RegkeyEnum.UPDATE_EXTERNAL_IDENTIFIER.resolveEndpoint(uuid);
            Request request = new RichHttpRequestBuilder()
                    .withUrl(url)
                    .withMethod(Method.Post())
                    .withJsonContent(payload)
                    .withHeader("X-ING-LastUpdateUse", "IN_ADMIN")
                    .build();
            return apiClient.apply(request)
                    .thenApply(response -> {
                        if (response.statusCode() >= 200 && response.statusCode() < 300) {
                            return null;
                        } else {
                            throw new DataDistributionApiException(
                                    RegkeyEnum.UPDATE_EXTERNAL_IDENTIFIER,
                                    "Failed to update external identifier",
                                    "Status: " + response.statusCode()
                            );
                        }
                    });
        } catch (RichHttpRequestBuilderException e) {
            throw new DataDistributionApiException(
                    RegkeyEnum.UPDATE_EXTERNAL_IDENTIFIER,
                    "Failed to build request for update external identifier API",
                    e.getMessage()
            );
        }

    }

    public CompletableFuture<Void> createOrganisationUnitHierarchy(OrganisationUnitOrganisationRelationshipRequest payload) {
        try {
            String url = RegkeyEnum.CREATE_ORGANISATION_UNIT_HIERARCHY.endpoint;
            Request request = new RichHttpRequestBuilder()
                    .withUrl(url)
                    .withMethod(Method.Post())
                    .withJsonContent(payload)
                    .withHeader("X-ING-LastUpdateUse", "IN_ADMIN")
                    .build();
            return apiClient.apply(request)
                    .thenApply(response -> {
                        if (response.statusCode() >= 200 && response.statusCode() < 300) {
                            return null;
                        } else {
                            throw new DataDistributionApiException(
                                    RegkeyEnum.CREATE_ORGANISATION_UNIT_HIERARCHY,
                                    "Failed to create organisation unit hierarchy",
                                    "Status: " + response.statusCode()
                            );
                        }
                    });
        } catch (RichHttpRequestBuilderException e) {
            throw new DataDistributionApiException(
                    RegkeyEnum.CREATE_ORGANISATION_UNIT_HIERARCHY,
                    "Failed to build request for organisation unit hierarchy API",
                    e.getMessage()
            );
        }
    }

    public CompletableFuture<SearchInvolvedPartiesResponseV1> searchInvolvedPartyByInternalIdentifier(SearchInvolvedPartiesRequestV1 payload) {
        try {
            String url = RegkeyEnum.SEARCH_ORGANISATION_UNIT.endpoint;  // ✅ dynamically from enum
            log.info("searchInvolvedPartyByInternalIdentifier request payload: {}", payload);
            String jsonPayload = objectMapper.writeValueAsString(payload);
            Request request = new RichHttpRequestBuilder()
                    .withUrl(url)
                    .withMethod(Method.Post())
                    .withJsonContent(jsonPayload)
                    .withHeader("Content-Type", "application/json")
                    .build();
            printRequest(request);
            return apiClient.apply(request)
                    .thenApply(response -> {
                        try {
                            log.info("searchInvolvedPartyByInternalIdentifier response: {}", response);
                            return objectMapper.readValue(response.contentString(), SearchInvolvedPartiesResponseV1.class);
                        } catch (Exception e) {
                            log.error("searchInvolvedPartyByInternalIdentifier error: {}", e.getMessage());
                            throw new DataDistributionApiException(
                                    RegkeyEnum.SEARCH_ORGANISATION_UNIT,
                                    "Failed to parse response from search organisation unit API",
                                    e.getMessage()
                            );
                        }
                    });
        } catch (Exception e) {
            log.error("searchInvolvedPartyByInternalIdentifier API error: {}", e.getMessage());
            throw new DataDistributionApiException(
                    RegkeyEnum.SEARCH_ORGANISATION_UNIT,
                    "Failed to build request for search organisation unit API",
                    e.getMessage()
            );
        }
    }

    public CompletableFuture<UpdateOrganisationUnitNameV5Response> updateOrganisationUnitName(
            UpdateOrganisationUnitNameV5Request payload, String uuid, String nameType) {
        try {
            String url = RegkeyEnum.UPDATE_ORGANISATION_UNIT_NAME.resolveEndpoint(uuid, nameType);
            Request request = new RichHttpRequestBuilder()
                    .withUrl(url)
                    .withMethod(Method.Patch())
                    .withJsonContent(payload)
                    .withHeader("X-ING-LastUpdateUser", "X-ING-LastUpdateUser")
                    .build();
            return apiClient.apply(request)
                    .thenApply(response -> {
                        try {
                            return objectMapper.readValue(response.contentString(), UpdateOrganisationUnitNameV5Response.class);
                        } catch (Exception e) {
                            throw new DataDistributionApiException(
                                    RegkeyEnum.UPDATE_ORGANISATION_UNIT_NAME,
                                    "Failed to parse response from updateOrganisationUnitName API",
                                    e.getMessage()
                            );
                        }
                    });
        } catch (RichHttpRequestBuilderException e) {
            throw new DataDistributionApiException(
                    RegkeyEnum.UPDATE_ORGANISATION_UNIT_NAME,
                    "Failed to build request for updateOrganisationUnitName API",
                    e.getMessage()
            );
        }
    }

    public CompletableFuture<UpdateInvolvedPartyResponseV5> updateInvolvedParty(UpdateInvolvedPartyRequestV5 payload, String uuid) {
        try {
            String url = RegkeyEnum.UPDATE_INVOLVED_PARTY.resolveEndpoint(uuid);
            Request request = new RichHttpRequestBuilder()
                    .withUrl(url)
                    .withMethod(Method.Patch())
                    .withJsonContent(payload)
                    .withHeader("X-ING-LastUpdateUser", "X-ING-LastUpdateUser")
                    .build();
            return apiClient.apply(request)
                    .thenApply(response -> {
                        try {
                            return objectMapper.readValue(response.contentString(), UpdateInvolvedPartyResponseV5.class);
                        } catch (Exception e) {
                            throw new DataDistributionApiException(
                                    RegkeyEnum.UPDATE_INVOLVED_PARTY,
                                    "Failed to parse response for Update InvolvedParty Request API",
                                    e.getMessage()
                            );
                        }
                    });
        } catch (RichHttpRequestBuilderException e) {
            throw new DataDistributionApiException(
                    RegkeyEnum.UPDATE_INVOLVED_PARTY,
                    "Failed to build request for Update InvolvedParty Request API",
                    e.getMessage()
            );
        }
    }

    private static void printRequest(Request req) {
        try {
            log.info("----- Request Details -----");
            log.info("Method: {}", req.method());
            log.info("URI: {}", req.uri());
            log.info("Version: {}", req.version());
            Map<String, String> headerMap = JavaConverters.mapAsJavaMapConverter(req.headerMap()).asJava();
            for (Map.Entry<String, String> entry : headerMap.entrySet()) {
                log.info("Header: {}: {}", entry.getKey(), entry.getValue());
            }
            log.info("Body: {}", req.contentString());
            log.info("---------------------------");
        } catch (Exception e) {
            log.error("Exception while printing request", e);
        }
    }

    public CompletableFuture<Void> createPostalAddress(String uuid, CreatePostalAddressRequest payload) {
        try {
            String url = RegkeyEnum.CREATE_POSTAL_ADDRESS.resolveEndpoint(uuid);
            log.info("Calling OnePAM API to create postal address for UUID: {}", uuid);
            Request request = new RichHttpRequestBuilder()
                    .withUrl(url)
                    .withMethod(Method.Patch())
                    .withJsonContent(payload)
                    .withHeader("X-ING-LastUpdateUser", "X-ING-LastUpdateUser")
                    .build();
            return apiClient.apply(request)
                    .thenApply(response -> {
                        if (response.statusCode() >= 200 && response.statusCode() < 300) {
                            log.info("Postal address created successfully for UUID: {}", uuid);
                            return null;
                        } else {
                            log.error("Failed to create postal address. Status: {}", response.statusCode());
                            throw new DataDistributionApiException(
                                    RegkeyEnum.CREATE_POSTAL_ADDRESS,
                                    "Failed to create postal address",
                                    "Status: " + response.statusCode()
                            );
                        }
                    });
        } catch (RichHttpRequestBuilderException e) {
            throw new DataDistributionApiException(
                    RegkeyEnum.CREATE_POSTAL_ADDRESS,
                    "Failed to build request for postal address creation",
                    e.getMessage()
            );
        }
    }
}
